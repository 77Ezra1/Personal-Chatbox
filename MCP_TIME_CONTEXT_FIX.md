# MCP服务时间上下文修复报告

## 问题描述

调用MCP服务（如搜索工具）时，AI无法获取到真实的当前时间，导致在查询实时数据时返回错误或过时的信息。

### 具体症状
- 用户询问"最新的AI新闻"时，搜索可能使用错误的年份
- 查询"今天的天气"时，AI不知道"今天"是哪一天
- 所有时间相关的查询都缺少准确的时间上下文

## 根本原因

在 `server/utils/dynamic-prompt-generator.cjs` 中，生成的动态System Prompt **没有包含当前日期和时间信息**。虽然AI模型被告知要使用工具获取实时数据，但它不知道"现在"是什么时间，导致：

1. 搜索查询中使用错误的时间参数
2. 无法正确理解"今天"、"现在"、"最新"等相对时间概念
3. 时间敏感的查询返回不准确的结果

## 解决方案

### 修改文件
`server/utils/dynamic-prompt-generator.cjs`

### 修改内容

#### 1. 在函数开始时获取当前时间信息

```javascript
// 🔥 获取当前日期和时间信息
const now = new Date();
const dateString = now.toLocaleDateString('zh-CN', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
  weekday: 'long'
});
const timeString = now.toLocaleTimeString('zh-CN', {
  hour: '2-digit',
  minute: '2-digit',
  hour12: false
});
const isoString = now.toISOString();
const timestamp = now.getTime();
```

#### 2. 在System Prompt中注入时间信息

在动态生成的System Prompt最开头添加了时间信息部分：

```
=== 🕐 重要：当前时间信息 ===

请务必记住以下时间信息，在处理涉及时间的查询时使用：
- **当前日期**：2025年1月28日星期二
- **当前时间**：14:30
- **ISO格式**：2025-01-28T06:30:00.000Z
- **Unix时间戳**：1738046600000

**重要规则**：
1. 当用户询问"今天"、"现在"、"最新"、"近期"等时间相关问题时，使用上述准确的日期时间
2. 在搜索查询中包含具体的年份和月份（例如："2025年1月 最新AI新闻"）
3. 对于新闻查询，确保使用当前年份（2025）而不是过去的年份
4. 所有时间相关的查询都必须基于上述真实时间信息
```

## 修改效果

### 修改前
```
用户：最新的AI新闻有哪些？
AI：调用brave_search_web({query: "AI新闻"})
结果：返回可能混合了2024年甚至更早的新闻
```

### 修改后
```
用户：最新的AI新闻有哪些？
AI：[知道现在是2025年1月28日]
    调用brave_search_web({query: "2025年1月 最新AI新闻"})
结果：返回准确的2025年1月最新新闻
```

## 生效方式

时间信息会在**每次生成System Prompt时实时计算**，确保：
- 每次对话都使用准确的当前时间
- 长时间运行的服务器也能提供正确的时间信息
- 跨时区的用户也能获得正确的时间上下文（基于服务器时区）

## 如何测试

### 1. 重启服务器
```bash
npm run dev
# 或
node server/index.cjs
```

### 2. 测试查询示例

**测试1：最新新闻查询**
```
问：最新的AI新闻有哪些？
期望：搜索查询包含"2025年"
```

**测试2：今天的信息**
```
问：今天发生了什么重要事件？
期望：AI知道今天是具体日期（如2025年1月28日）
```

**测试3：时间敏感数据**
```
问：现在比特币的价格是多少？
期望：查询使用准确的时间戳
```

### 3. 验证日志

查看服务器日志，应该能看到：
```
[DynamicPrompt] 生成动态Prompt: XX个工具, 场景: general, 当前时间: 2025年1月28日星期二 14:30
```

## 额外优化建议

### 1. 时区配置（可选）
如果需要支持用户特定时区，可以考虑：
- 在用户配置中添加时区设置
- 在生成Prompt时使用用户指定的时区

### 2. 时间格式本地化（可选）
当前使用中文格式，如需支持多语言：
- 根据用户语言设置选择合适的日期时间格式
- 提供多种时间格式（中文、英文、ISO等）

### 3. 相对时间提示（可选）
添加更多相对时间的说明：
```
- 昨天：2025年1月27日
- 上周：2025年1月20日 - 1月26日
- 本月：2025年1月
```

## 影响范围

### 受益的功能
✅ 所有使用MCP搜索服务的查询（Brave Search、Wikipedia等）
✅ 时间相关的数据查询（天气、新闻、价格等）
✅ 需要时间上下文的Agent任务
✅ Workflow中涉及时间的步骤

### 不影响的功能
- 文件操作工具（不需要时间上下文）
- 代码生成功能
- 静态数据查询

## 版本信息

- **修复日期**：2025-01-28
- **修改文件**：`server/utils/dynamic-prompt-generator.cjs`
- **影响范围**：所有使用动态System Prompt的对话
- **向后兼容**：是（完全兼容现有功能）

## 总结

通过在动态System Prompt中注入准确的时间信息，AI现在能够：
1. ✅ 知道"现在"是什么时间
2. ✅ 正确理解"今天"、"最新"等相对时间概念
3. ✅ 在搜索查询中使用正确的时间参数
4. ✅ 返回准确的实时数据

这个修复显著提升了所有涉及时间的查询的准确性，确保用户获得真正的"实时"信息！
