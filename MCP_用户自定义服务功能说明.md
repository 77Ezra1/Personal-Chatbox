# MCP 用户自定义服务功能说明

## 📋 功能概述

全新的 MCP 服务管理系统现已支持**用户自定义服务配置**，用户可以从丰富的模板库中选择并添加自己需要的 MCP 服务，无需手动编写复杂的配置文件。

---

## ✨ 新增功能

### 1. **MCP 服务模板市场**
- 📚 **丰富的模板库**：提供数十种官方和社区 MCP 服务模板
- 🗂️ **分类浏览**：按开发、数据库、自动化、云服务等分类组织
- 🔍 **实时搜索**：支持按名称、描述快速查找服务
- ⭐ **热门推荐**：标注官方、热门、推荐等标签，帮助选择

### 2. **一键添加服务**
- ➕ **从模板添加**：选择模板 → 配置参数 → 一键启用
- 🔧 **智能配置**：自动识别需要的环境变量和参数
- 📝 **配置向导**：提供详细的设置说明和文档链接
- ✅ **即时启动**：添加后自动启动服务，无需重启应用

### 3. **用户配置管理**
- 💾 **持久化存储**：配置保存到数据库，跨会话保留
- 🔄 **动态启停**：实时启用/禁用服务，无需重启
- ✏️ **灵活编辑**：支持修改服务配置和环境变量
- 🗑️ **轻松删除**：随时删除不需要的服务

---

## 🎯 使用流程

### 步骤 1: 打开 MCP Services 设置
1. 点击右上角设置图标
2. 选择 "MCP Services" 标签页
3. 查看当前所有服务（系统内置 + 用户自定义）

### 步骤 2: 添加新服务
1. 点击左上角的 **"添加服务"** 按钮
2. 弹出服务模板对话框

### 步骤 3: 浏览和选择模板
1. **按分类浏览**：
   - 开发工具（Development）
   - 数据库（Database）
   - 自动化（Automation）
   - 云服务（Cloud）
   - 系统工具（System）
   - 其他（Other）

2. **搜索服务**：
   - 在搜索框输入关键词
   - 实时过滤匹配的服务

3. **查看详情**：
   - 服务名称和图标
   - 功能描述
   - 官方/热门标签
   - 主要功能列表

### 步骤 4: 配置和添加
1. 点击模板卡片上的 **"添加"** 按钮
2. **如果需要配置**：
   - 填写必要的环境变量（如 API Token、数据库连接字符串等）
   - 查看设置说明
   - 点击官方文档链接了解详情
   - 确认添加
3. **如果无需配置**：
   - 直接添加并启动

### 步骤 5: 管理服务
1. **启用/禁用**：点击服务卡片右侧的开关
2. **查看状态**：已启用的服务会高亮显示
3. **筛选查看**：
   - 全部：显示所有服务
   - 系统内置：只显示预装服务
   - 用户自定义：只显示用户添加的服务

---

## 📚 可用的服务模板

### 开发工具（Development）
- **GitHub** 🔧
  - 仓库管理、Issue/PR 操作、代码搜索
  - 需要：GitHub Personal Access Token

- **GitLab** 🦊
  - GitLab 项目管理和 CI/CD
  - 需要：GitLab Access Token

### 数据库（Database）
- **PostgreSQL** 🐘
  - SQL 查询、表结构管理、数据分析
  - 需要：数据库连接字符串

- **MySQL** 🐬
  - MySQL 数据库操作
  - 需要：数据库连接字符串

- **MongoDB** 🍃
  - MongoDB 文档数据库
  - 需要：连接字符串

- **Redis** 🔴
  - Redis 缓存操作
  - 需要：连接字符串

### 自动化（Automation）
- **Puppeteer** 🎭
  - 浏览器自动化、网页截图、PDF 生成
  - 无需配置

- **Playwright** 🎪
  - 现代浏览器自动化
  - 无需配置

### 云服务（Cloud）
- **AWS** ☁️
  - AWS 云服务管理
  - 需要：AWS 凭证

- **Google Cloud** 🌐
  - GCP 服务管理
  - 需要：GCP 凭证

### 系统工具（System）
- **Filesystem** 📁
  - 安全的文件系统操作
  - 需要：允许访问的目录路径

还有更多服务持续更新中...

---

## 🏗️ 技术架构

### 前端组件
```
src/
├── components/mcp/
│   ├── McpServicesPanel.jsx         # 主面板（已更新）
│   └── AddMcpServiceDialog.jsx      # 添加服务对话框（新增）
├── hooks/
│   ├── useMcpTemplates.js           # 模板管理 Hook（新增）
│   └── useMcpUserConfigs.js         # 用户配置管理 Hook（新增）
```

### 后端 API
```
server/
├── routes/mcp.cjs                   # MCP 路由（已扩展）
├── services/mcp-manager.cjs         # MCP 管理器（动态启停）
├── data/mcp-templates.json          # 服务模板库
└── db/migrations/
    └── 022-add-user-mcp-configs.sql # 数据库表
```

### 数据库表
```sql
CREATE TABLE user_mcp_configs (
  id INTEGER PRIMARY KEY,
  user_id INTEGER,
  mcp_id TEXT,              -- 服务ID
  enabled BOOLEAN,          -- 启用状态
  name TEXT,                -- 服务名称
  description TEXT,         -- 描述
  category TEXT,            -- 分类
  icon TEXT,                -- 图标
  command TEXT,             -- 执行命令
  args TEXT,                -- 参数（JSON）
  env_vars TEXT,            -- 环境变量（JSON）
  config_data TEXT,         -- 其他配置（JSON）
  official BOOLEAN,         -- 是否官方
  popularity TEXT,          -- 热门程度
  features TEXT,            -- 功能列表（JSON）
  setup_instructions TEXT,  -- 设置说明（JSON）
  documentation TEXT,       -- 文档链接
  created_at DATETIME,
  updated_at DATETIME
);
```

---

## 🔌 API 端点

### 模板相关
- `GET /api/mcp/templates` - 获取所有模板
- `POST /api/mcp/user-configs/from-template` - 从模板创建配置

### 用户配置相关
- `GET /api/mcp/user-configs` - 获取用户配置列表
- `POST /api/mcp/user-configs` - 创建新配置
- `PUT /api/mcp/user-configs/:id` - 更新配置
- `DELETE /api/mcp/user-configs/:id` - 删除配置
- `POST /api/mcp/user-configs/:id/toggle` - 切换启用状态
- `POST /api/mcp/user-configs/:id/test` - 测试连接

---

## 🔄 工作流程

### 添加服务流程
```
用户点击"添加服务"
  ↓
加载模板库
  ↓
用户选择模板
  ↓
检查是否需要配置
  ↓
[需要配置] → 显示配置表单 → 用户填写 → 验证
[无需配置] → 直接添加
  ↓
调用 API 创建配置
  ↓
后端保存到数据库
  ↓
动态启动 MCP 服务
  ↓
前端刷新服务列表
  ↓
用户看到新服务（已启用）
```

### 启用/禁用流程
```
用户点击服务开关
  ↓
调用 toggle API
  ↓
后端更新数据库
  ↓
[启用] → 启动 MCP 服务进程
[禁用] → 停止 MCP 服务进程
  ↓
返回新状态
  ↓
前端更新 UI
```

---

## 🎨 UI 设计特点

### 添加服务对话框
- **大屏全屏对话框**：提供充足的浏览空间
- **双标签页**：
  - "从模板添加"：模板市场
  - "手动配置"：自定义配置（即将推出）
- **分类筛选**：快速定位所需类别
- **实时搜索**：即输即搜
- **卡片网格布局**：2 列响应式布局

### 模板卡片
- **大图标 + 名称**：易识别
- **官方/热门标签**：突出推荐
- **功能列表**：展示前 4 个功能
- **添加按钮**：快速操作

### 配置表单
- **服务信息展示**：图标、名称、描述
- **环境变量输入**：
  - 敏感信息自动隐藏（password 类型）
  - 必填项标记（红色星号）
  - 占位符提示
- **设置说明**：蓝色提示框，中英文支持
- **文档链接**：外部链接图标
- **错误提示**：醒目的错误信息展示

### 服务列表增强
- **自定义标记**：用户添加的服务显示"自定义"徽章
- **区分颜色**：系统内置和用户自定义可视化区分
- **添加按钮**：左上角醒目位置

---

## 🔐 安全特性

### 数据安全
- ✅ 用户配置隔离：每个用户只能访问自己的配置
- ✅ SQL 注入防护：使用参数化查询
- ✅ 权限验证：所有 API 需要身份验证

### 服务安全
- ✅ 环境变量加密存储（建议）
- ✅ 进程隔离：每个 MCP 服务独立进程
- ✅ 错误隔离：单个服务失败不影响其他服务

---

## 🚀 性能优化

### 前端
- ✅ 模板数据缓存：避免重复加载
- ✅ 虚拟滚动（大数据量时）
- ✅ 防抖搜索：减少不必要的过滤计算

### 后端
- ✅ API 缓存：服务列表缓存 30 秒
- ✅ 延迟加载：按需启动服务
- ✅ 进程复用：避免重复启动

---

## 📝 使用建议

### 推荐添加的服务
1. **开发者必备**：
   - GitHub / GitLab（代码管理）
   - Filesystem（文件操作）
   - PostgreSQL / MySQL（数据库）

2. **数据分析**：
   - PostgreSQL（数据查询）
   - Redis（缓存分析）

3. **自动化测试**：
   - Puppeteer / Playwright（浏览器自动化）

4. **云服务集成**：
   - AWS / Google Cloud（云资源管理）

### 配置技巧
1. **GitHub Token**：
   - 访问 https://github.com/settings/tokens
   - 创建 Personal Access Token
   - 权限：repo, workflow, read:org

2. **数据库连接**：
   - 使用只读用户（安全）
   - 限制访问 IP
   - 定期轮换密码

3. **API Key 管理**：
   - 使用环境变量
   - 不要硬编码
   - 定期检查权限

---

## 🐛 故障排查

### 服务添加失败
- ✅ 检查网络连接
- ✅ 验证环境变量格式
- ✅ 查看控制台错误日志
- ✅ 确认数据库连接正常

### 服务无法启动
- ✅ 检查命令是否正确
- ✅ 验证参数格式
- ✅ 查看服务日志
- ✅ 确认依赖已安装

### 服务无响应
- ✅ 检查进程是否运行
- ✅ 查看超时设置
- ✅ 验证网络代理配置
- ✅ 重启服务

---

## 🎯 后续计划

### 短期（v1.1）
- [ ] 手动配置功能：支持完全自定义 MCP 服务
- [ ] 配置导入导出：备份和分享配置
- [ ] 服务健康检查：实时监控服务状态

### 中期（v1.2）
- [ ] 服务市场：社区共享模板
- [ ] 配置模板编辑器：可视化编辑模板
- [ ] 批量操作：批量启用/禁用/删除

### 长期（v2.0）
- [ ] 服务编排：配置服务依赖和执行顺序
- [ ] 性能监控：服务调用统计和分析
- [ ] 智能推荐：根据使用习惯推荐服务

---

## 📚 参考资料

- [MCP 官方文档](https://modelcontextprotocol.io/)
- [MCP 服务器列表](https://github.com/modelcontextprotocol/servers)
- [项目 GitHub](https://github.com/77Ezra1/AI-Life-system)

---

**✅ 功能已完成！**

现在用户可以轻松添加和管理自己需要的 MCP 服务，无需编写复杂的配置文件！🎉

