<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MCPå·¥å…·è°ƒç”¨å®Œæ•´æµ‹è¯•</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      border-bottom: 2px solid #4CAF50;
      padding-bottom: 10px;
    }
    .test-section {
      margin: 20px 0;
      padding: 15px;
      background: #f9f9f9;
      border-left: 4px solid #2196F3;
    }
    .success {
      color: #4CAF50;
      font-weight: bold;
    }
    .error {
      color: #f44336;
      font-weight: bold;
    }
    .warning {
      color: #ff9800;
      font-weight: bold;
    }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px 20px;
      font-size: 16px;
      border-radius: 4px;
      cursor: pointer;
      margin: 10px 5px;
    }
    button:hover {
      background: #45a049;
    }
    pre {
      background: #263238;
      color: #aed581;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
    }
    .log {
      background: #263238;
      color: #fff;
      padding: 15px;
      border-radius: 4px;
      max-height: 400px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”§ MCPå·¥å…·è°ƒç”¨å®Œæ•´æµ‹è¯•</h1>
    
    <div class="test-section">
      <h2>æµ‹è¯•æ­¥éª¤</h2>
      <button onclick="runAllTests()">â–¶ï¸ è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
      <button onclick="clearLogs()">ğŸ—‘ï¸ æ¸…é™¤æ—¥å¿—</button>
    </div>
    
    <div class="test-section">
      <h2>æµ‹è¯•ç»“æœ</h2>
      <div id="results"></div>
    </div>
    
    <div class="test-section">
      <h2>è¯¦ç»†æ—¥å¿—</h2>
      <div class="log" id="logs"></div>
    </div>
  </div>

  <script type="module">
    const API_KEY = 'sk-03db8009812649359e2f83cc738861aa'
    const API_ENDPOINT = 'https://api.deepseek.com/v1/chat/completions'
    
    const DB_NAME = 'ai-life-system-db'
    const DB_VERSION = 3
    
    let logContainer, resultsContainer
    
    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString()
      const color = type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : type === 'warning' ? '#ff9800' : '#fff'
      logContainer.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`
      logContainer.scrollTop = logContainer.scrollHeight
    }
    
    function addResult(title, status, details = '') {
      const statusClass = status === 'success' ? 'success' : status === 'error' ? 'error' : 'warning'
      const statusIcon = status === 'success' ? 'âœ…' : status === 'error' ? 'âŒ' : 'âš ï¸'
      resultsContainer.innerHTML += `
        <div style="margin: 10px 0; padding: 10px; background: white; border-radius: 4px;">
          <span class="${statusClass}">${statusIcon} ${title}</span>
          ${details ? `<div style="margin-top: 5px; font-size: 14px; color: #666;">${details}</div>` : ''}
        </div>
      `
    }
    
    async function test1_CheckDatabase() {
      log('=== æµ‹è¯•1: æ£€æŸ¥IndexedDBæ•°æ®åº“ ===')
      
      try {
        const db = await new Promise((resolve, reject) => {
          const request = indexedDB.open(DB_NAME, DB_VERSION)
          request.onsuccess = () => resolve(request.result)
          request.onerror = () => reject(request.error)
        })
        
        log('âœ“ æ•°æ®åº“è¿æ¥æˆåŠŸ', 'success')
        
        // æ£€æŸ¥MCPæœåŠ¡
        const transaction = db.transaction(['mcp_servers'], 'readonly')
        const store = transaction.objectStore('mcp_servers')
        const services = await new Promise((resolve, reject) => {
          const req = store.getAll()
          req.onsuccess = () => resolve(req.result)
          req.onerror = () => reject(req.error)
        })
        
        log(`âœ“ æ‰¾åˆ° ${services.length} ä¸ªMCPæœåŠ¡`, 'success')
        const enabledServices = services.filter(s => s.isEnabled)
        log(`âœ“ å…¶ä¸­ ${enabledServices.length} ä¸ªå·²å¯ç”¨`, 'success')
        
        enabledServices.forEach(s => {
          log(`  - ${s.name} (${s.type})`)
        })
        
        db.close()
        
        addResult('æ•°æ®åº“æ£€æŸ¥', 'success', `æ‰¾åˆ°${enabledServices.length}ä¸ªå·²å¯ç”¨çš„MCPæœåŠ¡`)
        return { success: true, enabledServices }
        
      } catch (error) {
        log(`âœ— æ•°æ®åº“æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error')
        addResult('æ•°æ®åº“æ£€æŸ¥', 'error', error.message)
        return { success: false, error }
      }
    }
    
    async function test2_CheckSystemPrompt() {
      log('=== æµ‹è¯•2: æ£€æŸ¥ç³»ç»Ÿæç¤ºè¯ ===')
      
      try {
        const db = await new Promise((resolve, reject) => {
          const request = indexedDB.open(DB_NAME, DB_VERSION)
          request.onsuccess = () => resolve(request.result)
          request.onerror = () => reject(request.error)
        })
        
        const transaction = db.transaction(['system_prompts'], 'readonly')
        const store = transaction.objectStore('system_prompts')
        const systemPrompt = await new Promise((resolve, reject) => {
          const req = store.get('default')
          req.onsuccess = () => resolve(req.result)
          req.onerror = () => reject(req.error)
        })
        
        if (!systemPrompt || !systemPrompt.globalPrompt) {
          log('âœ“ æœªè®¾ç½®ç³»ç»Ÿæç¤ºè¯', 'success')
          addResult('ç³»ç»Ÿæç¤ºè¯æ£€æŸ¥', 'success', 'æœªè®¾ç½®ç³»ç»Ÿæç¤ºè¯')
          db.close()
          return { success: true, hasPrompt: false }
        }
        
        log(`ç³»ç»Ÿæç¤ºè¯æ¨¡å¼: ${systemPrompt.mode}`)
        log(`å…¨å±€æç¤ºè¯é•¿åº¦: ${systemPrompt.globalPrompt.length}å­—ç¬¦`)
        
        const problematicPatterns = [
          'tool_calls_begin',
          'tool_call_begin',
          'tool_sep',
          'tool_calls_end',
          'tool_call_end',
          '<|',
          '|>'
        ]
        
        const foundProblems = problematicPatterns.filter(pattern => 
          systemPrompt.globalPrompt.includes(pattern)
        )
        
        if (foundProblems.length > 0) {
          log(`âœ— å‘ç°å¹²æ‰°æ€§å†…å®¹: ${foundProblems.join(', ')}`, 'error')
          addResult('ç³»ç»Ÿæç¤ºè¯æ£€æŸ¥', 'error', `åŒ…å«å¹²æ‰°æ€§æ ‡è®°: ${foundProblems.join(', ')}`)
          db.close()
          return { success: false, hasProblems: true, problems: foundProblems }
        }
        
        log('âœ“ ç³»ç»Ÿæç¤ºè¯æ­£å¸¸', 'success')
        addResult('ç³»ç»Ÿæç¤ºè¯æ£€æŸ¥', 'success', 'æœªå‘ç°å¹²æ‰°æ€§å†…å®¹')
        db.close()
        return { success: true, hasPrompt: true, hasProblems: false }
        
      } catch (error) {
        log(`âœ— æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error')
        addResult('ç³»ç»Ÿæç¤ºè¯æ£€æŸ¥', 'error', error.message)
        return { success: false, error }
      }
    }
    
    async function test3_TestAPICall() {
      log('=== æµ‹è¯•3: æµ‹è¯•DeepSeek APIå·¥å…·è°ƒç”¨ ===')
      
      const tools = [
        {
          type: 'function',
          function: {
            name: 'duckduckgo_search',
            description: 'ä½¿ç”¨DuckDuckGoè¿›è¡Œç½‘ç»œæœç´¢',
            parameters: {
              type: 'object',
              properties: {
                query: { type: 'string', description: 'æœç´¢æŸ¥è¯¢è¯' },
                max_results: { type: 'number', description: 'æœ€å¤§ç»“æœæ•°é‡', default: 10 }
              },
              required: ['query']
            }
          }
        }
      ]
      
      const requestBody = {
        model: 'deepseek-chat',
        messages: [
          { role: 'user', content: 'å¸®æˆ‘åˆ†æä¸€ä¸‹2025å¹´ä¸­å›½çš„ç¾å¦†å¸‚åœº' }
        ],
        tools,
        tool_choice: 'auto',
        temperature: 0.7,
        max_tokens: 2000
      }
      
      log('å‘é€APIè¯·æ±‚...')
      
      try {
        const response = await fetch(API_ENDPOINT, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${API_KEY}`
          },
          body: JSON.stringify(requestBody)
        })
        
        if (!response.ok) {
          const errorText = await response.text()
          throw new Error(`APIé”™è¯¯: ${response.status} - ${errorText}`)
        }
        
        const data = await response.json()
        const message = data?.choices?.[0]?.message
        
        log('âœ“ APIè°ƒç”¨æˆåŠŸ', 'success')
        
        if (message?.tool_calls && message.tool_calls.length > 0) {
          log(`âœ“ æ£€æµ‹åˆ° ${message.tool_calls.length} ä¸ªå·¥å…·è°ƒç”¨`, 'success')
          message.tool_calls.forEach(tc => {
            log(`  - ${tc.function.name}: ${tc.function.arguments}`)
          })
          addResult('APIå·¥å…·è°ƒç”¨æµ‹è¯•', 'success', `æˆåŠŸæ£€æµ‹åˆ°${message.tool_calls.length}ä¸ªå·¥å…·è°ƒç”¨`)
          return { success: true, hasToolCalls: true, toolCalls: message.tool_calls }
        } else {
          log('âœ— æœªæ£€æµ‹åˆ°å·¥å…·è°ƒç”¨', 'error')
          log(`è¿”å›å†…å®¹: ${message?.content}`)
          addResult('APIå·¥å…·è°ƒç”¨æµ‹è¯•', 'error', 'æœªæ£€æµ‹åˆ°å·¥å…·è°ƒç”¨')
          return { success: false, hasToolCalls: false, content: message?.content }
        }
        
      } catch (error) {
        log(`âœ— APIè°ƒç”¨å¤±è´¥: ${error.message}`, 'error')
        addResult('APIå·¥å…·è°ƒç”¨æµ‹è¯•', 'error', error.message)
        return { success: false, error }
      }
    }
    
    async function runAllTests() {
      logContainer = document.getElementById('logs')
      resultsContainer = document.getElementById('results')
      
      logContainer.innerHTML = ''
      resultsContainer.innerHTML = ''
      
      log('å¼€å§‹è¿è¡Œæ‰€æœ‰æµ‹è¯•...', 'success')
      log('')
      
      const result1 = await test1_CheckDatabase()
      log('')
      
      const result2 = await test2_CheckSystemPrompt()
      log('')
      
      const result3 = await test3_TestAPICall()
      log('')
      
      log('=== æµ‹è¯•å®Œæˆ ===', 'success')
      log('')
      
      // ç”Ÿæˆè¯Šæ–­æŠ¥å‘Š
      if (result3.success && result3.hasToolCalls) {
        log('âœ“ æ‰€æœ‰æµ‹è¯•é€šè¿‡! MCPå·¥å…·è°ƒç”¨åŠŸèƒ½æ­£å¸¸', 'success')
        log('å¦‚æœåº”ç”¨ä¸­ä»ç„¶ä¸å·¥ä½œ,å¯èƒ½æ˜¯Reactç»„ä»¶çŠ¶æ€é—®é¢˜', 'warning')
        log('å»ºè®®: åˆ·æ–°åº”ç”¨é¡µé¢æˆ–æ¸…é™¤æµè§ˆå™¨ç¼“å­˜', 'warning')
      } else if (result2.hasProblems) {
        log('âœ— é—®é¢˜åŸå› : ç³»ç»Ÿæç¤ºè¯åŒ…å«å¹²æ‰°æ€§å†…å®¹', 'error')
        log('ä¿®å¤æ–¹æ³•: æ‰“å¼€åº”ç”¨è®¾ç½® > ç³»ç»Ÿæç¤ºè¯ > åˆ é™¤åŒ…å«ç‰¹æ®Šæ ‡è®°çš„å†…å®¹', 'warning')
      } else if (!result1.success) {
        log('âœ— é—®é¢˜åŸå› : æ•°æ®åº“æœªåˆå§‹åŒ–æˆ–æŸå', 'error')
        log('ä¿®å¤æ–¹æ³•: æ‰“å¼€åº”ç”¨è®©æ•°æ®åº“è‡ªåŠ¨åˆå§‹åŒ–', 'warning')
      } else {
        log('âœ— é—®é¢˜åŸå› æœªçŸ¥,éœ€è¦è¿›ä¸€æ­¥è°ƒæŸ¥', 'error')
        log('å»ºè®®: æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°çš„å®Œæ•´æ—¥å¿—', 'warning')
      }
    }
    
    function clearLogs() {
      document.getElementById('logs').innerHTML = ''
      document.getElementById('results').innerHTML = ''
    }
    
    window.runAllTests = runAllTests
    window.clearLogs = clearLogs
    
    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œ
    window.addEventListener('load', () => {
      setTimeout(runAllTests, 500)
    })
  </script>
</body>
</html>

