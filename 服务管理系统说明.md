# 🔧 服务管理系统使用说明

## ✅ 功能完成

现在所有可用的MCP服务和内置服务都已**默认内置并启动**！用户可以通过前端界面随时控制每个服务的开关。

---

## 🌟 主要特性

### 1. 智能服务分类

| 类别 | 说明 | 数量 |
|------|------|------|
| **免费服务** | 无需配置，开箱即用 | 15个 |
| **需要API Key** | 需要用户配置密钥 | 6个 |
| **MCP外部服务** | 通过MCP协议调用 | 16个 |
| **内置服务** | 系统内置实现 | 9个 |

### 2. 用户个性化配置

- ✅ 每个用户独立的服务配置
- ✅ 配置保存到数据库
- ✅ 默认启用所有免费服务
- ✅ 实时切换服务状态

### 3. 前端可视化管理

- ✅ 漂亮的服务卡片展示
- ✅ 一键开关服务
- ✅ 批量保存配置
- ✅ 服务状态实时显示

---

## 📂 文件结构

### 后端文件

```
server/
├── routes/
│   └── services.cjs          # 新增：服务管理API
└── index.cjs                 # 已修改：注册services路由
```

### 前端文件

```
src/
└── components/
    └── settings/
        ├── ServicesManager.jsx      # 新增：服务管理组件
        ├── ServicesManager.css      # 新增：样式文件
        └── SettingsPage.jsx         # 已修改：集成服务管理
```

---

## 🔌 API接口

### 1. 获取服务列表

```bash
GET /api/services
Authorization: Bearer {token}
```

**响应示例**:
```json
{
  "services": [
    {
      "id": "memory",
      "name": "Memory记忆系统",
      "description": "知识图谱式的持久化记忆系统",
      "type": "mcp",
      "category": "free",
      "enabled": true,
      "systemDefault": true,
      "requiresConfig": false
    },
    // ... 更多服务
  ],
  "stats": {
    "total": 25,
    "enabled": 22,
    "free": 15,
    "requiresKey": 6
  }
}
```

### 2. 更新单个服务状态

```bash
PUT /api/services/:serviceId
Authorization: Bearer {token}
Content-Type: application/json

{
  "enabled": true
}
```

### 3. 批量更新服务

```bash
PUT /api/services/batch/update
Authorization: Bearer {token}
Content-Type: application/json

{
  "services": [
    { "id": "memory", "enabled": true },
    { "id": "wikipedia", "enabled": false }
  ]
}
```

---

## 💻 前端使用方式

### 步骤1: 打开设置页面

点击右上角的设置图标，进入设置页面。

### 步骤2: 选择"服务管理"标签

在侧边栏中选择 "🔧 服务管理" 标签。

### 步骤3: 管理服务

- **查看服务状态**: 绿色卡片=已启用，灰色=已禁用
- **开关服务**: 点击右侧的开关按钮
- **筛选服务**: 使用顶部的筛选标签
- **保存配置**: 会自动保存到数据库

### 步骤4: 重启生效

修改服务状态后，需要重启后端服务才能生效：

```bash
# 开发模式
npm run dev

# 生产模式
pm2 restart chatbox
```

---

## 🎨 界面功能说明

### 统计卡片

显示以下实时统计：
- 总服务数
- 已启用数量
- 免费服务数
- 需要Key的服务数

### 筛选标签

- **全部**: 显示所有服务
- **免费服务**: 只显示无需配置的服务
- **需要Key**: 只显示需要API Key的服务
- **MCP服务**: 只显示MCP外部服务
- **内置服务**: 只显示系统内置服务

### 服务卡片

每个服务卡片包含：
- 服务名称和描述
- 类型徽章（MCP/内置）
- 状态徽章（运行中/需要Key）
- 开关按钮
- 使用说明（部分服务）
- API Key获取链接（需要Key的服务）

---

## 📊 服务列表

### 免费MCP服务（默认启用）

1. **Memory记忆系统** - 知识图谱、实体关系
2. **Filesystem文件系统** - 文件读写、搜索
3. **Sequential Thinking** - 复杂推理
4. **SQLite数据库** - 数据库操作
5. **Wikipedia维基百科** - 百科知识查询
6. **Puppeteer浏览器** - 浏览器自动化

### 免费内置服务（默认启用）

7. **天气服务** - 全球天气信息
8. **时间服务** - 时间和时区转换
9. **Dexscreener** - 加密货币价格
10. **网页抓取** - 网页内容提取
11. **Playwright** - 浏览器自动化
12. **代码编辑器** - 代码修改工具
13. **命令执行器** - 系统命令执行
14. **代码质量工具** - Linter/Formatter
15. **测试运行器** - 测试执行

### 需要API Key的服务（默认禁用）

16. **Brave Search** - 高质量网页搜索
17. **GitHub** - 仓库管理
18. **Google Maps** - 位置服务
19. **EverArt** - AI图像生成
20. **Slack** - 消息通知
21. **PostgreSQL** - 生产级数据库

---

## 🔒 数据存储

### 数据库表: `user_configs`

```sql
CREATE TABLE user_configs (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER UNIQUE,
  mcp_config TEXT,  -- JSON格式的服务配置
  ...
);
```

### 配置格式

```json
{
  "memory": {
    "enabled": true,
    "updatedAt": "2025-10-24T16:30:00.000Z"
  },
  "wikipedia": {
    "enabled": false,
    "updatedAt": "2025-10-24T16:35:00.000Z"
  }
}
```

---

## 🚀 实现原理

### 1. 默认配置优先级

```javascript
用户配置 > 系统配置 > 默认值

// 示例
const userEnabled = userServicesConfig[serviceId]?.enabled !== undefined
  ? userServicesConfig[serviceId].enabled  // 优先使用用户配置
  : serviceConfig.enabled && serviceConfig.autoLoad && !serviceConfig.requiresConfig;  // 否则使用系统默认
```

### 2. 服务启动逻辑

1. 后端启动时读取`server/config.cjs`中的所有服务配置
2. 对于每个服务，检查是否:
   - `enabled: true`
   - `autoLoad: true`
   - `requiresConfig: false` （或用户已配置API Key）
3. 满足条件的服务自动启动
4. 用户配置覆盖系统默认配置

### 3. 前端交互流程

```
用户点击开关
  ↓
乐观更新UI（立即反映）
  ↓
发送API请求
  ↓
更新数据库
  ↓
成功：保持UI状态
失败：回滚UI状态
```

---

## ⚙️ 开发指南

### 添加新服务

#### 1. 在`server/config.cjs`中添加服务配置

```javascript
services: {
  // ...其他服务

  new_service: {
    id: 'new_service',
    name: '新服务名称',
    enabled: true,  // 默认启用
    autoLoad: true,  // 自动加载
    requiresConfig: false,  // 是否需要配置
    description: '服务描述',
    command: 'npx',  // MCP服务的启动命令
    args: ['-y', 'package-name']
  }
}
```

#### 2. 前端会自动获取并显示

无需修改前端代码，服务会自动出现在服务管理界面中。

---

## 🐛 故障排查

### 问题1: 修改后服务没有生效

**解决方案**:
- 检查是否重启了后端服务
- 查看`server-restart.log`日志
- 确认数据库中的配置已更新

### 问题2: 某个服务无法启动

**检查步骤**:
1. 查看服务是否需要API Key
2. 检查npm包是否存在
3. 查看后端启动日志
4. 确认系统依赖是否安装

### 问题3: 前端无法加载服务列表

**解决方案**:
- 检查用户是否已登录
- 确认Token是否有效
- 打开浏览器控制台查看错误信息
- 检查后端API是否正常运行

---

## 📈 未来优化方向

### 短期计划

- [ ] 热重启功能（无需手动重启）
- [ ] 服务健康监控
- [ ] 服务使用统计

### 长期计划

- [ ] 服务市场（社区贡献的服务）
- [ ] 自定义服务配置UI
- [ ] 服务依赖管理
- [ ] 服务性能监控

---

## 🎉 总结

现在你的AI聊天系统拥有：
- ✅ **25个专业服务**（15个免费 + 6个需Key + 4个禁用）
- ✅ **前端可视化管理**
- ✅ **用户个性化配置**
- ✅ **默认启用所有免费服务**
- ✅ **一键开关服务**
- ✅ **配置持久化存储**

**下一步**:
1. 打开前端设置页面
2. 选择"服务管理"标签
3. 查看并管理所有服务
4. 根据需要开关服务
5. 重启后端生效

---

**创建时间**: 2025-10-24
**系统版本**: v3.0 - 服务管理系统

