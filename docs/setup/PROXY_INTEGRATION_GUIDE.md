# åº”ç”¨å†…ä»£ç†ç½‘ç»œé›†æˆæ–¹æ¡ˆ

ä¸ºPersonal Chatboxé›†æˆä»£ç†ç½‘ç»œ,ä½¿MCPæœåŠ¡èƒ½å¤Ÿè®¿é—®å›½å¤–APIã€‚

---

## ğŸ“‹ ç›®å½•

1. [æ–¹æ¡ˆå¯¹æ¯”](#æ–¹æ¡ˆå¯¹æ¯”)
2. [æ¨èæ–¹æ¡ˆ](#æ¨èæ–¹æ¡ˆ)
3. [å®ç°æ­¥éª¤](#å®ç°æ­¥éª¤)
4. [é…ç½®ç•Œé¢](#é…ç½®ç•Œé¢)
5. [å®‰å…¨è€ƒè™‘](#å®‰å…¨è€ƒè™‘)
6. [æµ‹è¯•éªŒè¯](#æµ‹è¯•éªŒè¯)

---

## ğŸ¯ æ–¹æ¡ˆå¯¹æ¯”

### æ–¹æ¡ˆ1: HTTP/HTTPSä»£ç† (æ¨èâ­â­â­â­â­)

**åŸç†**: é€šè¿‡HTTPä»£ç†è½¬å‘æ‰€æœ‰å¤–éƒ¨è¯·æ±‚

**ä¼˜ç‚¹**:
- âœ… å®ç°ç®€å•
- âœ… å…¼å®¹æ€§å¥½
- âœ… æ”¯æŒæ‰€æœ‰HTTP/HTTPSè¯·æ±‚
- âœ… å¯ä»¥ä½¿ç”¨ç°æœ‰çš„ä»£ç†æœåŠ¡(Clash, V2Rayç­‰)

**ç¼ºç‚¹**:
- âš ï¸ éœ€è¦ç”¨æˆ·æä¾›ä»£ç†åœ°å€
- âš ï¸ åªæ”¯æŒHTTPåè®®

**é€‚ç”¨åœºæ™¯**: 
- ç”¨æˆ·å·²æœ‰ä»£ç†æœåŠ¡
- éœ€è¦å¿«é€Ÿå®ç°

---

### æ–¹æ¡ˆ2: SOCKS5ä»£ç† (æ¨èâ­â­â­â­)

**åŸç†**: é€šè¿‡SOCKS5åè®®è½¬å‘æ‰€æœ‰ç½‘ç»œè¯·æ±‚

**ä¼˜ç‚¹**:
- âœ… æ”¯æŒæ‰€æœ‰åè®®(HTTP, HTTPS, WebSocketç­‰)
- âœ… æ€§èƒ½æ›´å¥½
- âœ… æ›´åº•å±‚çš„ä»£ç†æ–¹å¼

**ç¼ºç‚¹**:
- âš ï¸ éœ€è¦é¢å¤–çš„ä¾èµ–åº“
- âš ï¸ é…ç½®ç¨å¤æ‚

**é€‚ç”¨åœºæ™¯**:
- éœ€è¦ä»£ç†WebSocketè¿æ¥
- å¯¹æ€§èƒ½è¦æ±‚é«˜

---

### æ–¹æ¡ˆ3: å†…ç½®ä»£ç†æœåŠ¡ (æ¨èâ­â­â­)

**åŸç†**: åœ¨åº”ç”¨å†…é›†æˆå®Œæ•´çš„ä»£ç†å®¢æˆ·ç«¯

**ä¼˜ç‚¹**:
- âœ… ç”¨æˆ·ä½“éªŒæœ€å¥½
- âœ… æ— éœ€å¤–éƒ¨é…ç½®
- âœ… å¯ä»¥æä¾›è®¢é˜…ç®¡ç†

**ç¼ºç‚¹**:
- âŒ å®ç°å¤æ‚
- âŒ éœ€è¦ç»´æŠ¤ä»£ç†èŠ‚ç‚¹
- âŒ å¯èƒ½æ¶‰åŠæ³•å¾‹é£é™©

**é€‚ç”¨åœºæ™¯**:
- å•†ä¸šäº§å“
- æœ‰ä¸“ä¸šå›¢é˜Ÿç»´æŠ¤

---

### æ–¹æ¡ˆ4: æ™ºèƒ½è·¯ç”± (æ¨èâ­â­â­â­â­)

**åŸç†**: æ ¹æ®ç›®æ ‡åŸŸåè‡ªåŠ¨é€‰æ‹©æ˜¯å¦ä½¿ç”¨ä»£ç†

**ä¼˜ç‚¹**:
- âœ… å›½å†…æœåŠ¡ç›´è¿,é€Ÿåº¦å¿«
- âœ… å›½å¤–æœåŠ¡èµ°ä»£ç†
- âœ… èŠ‚çœä»£ç†æµé‡
- âœ… ç”¨æˆ·ä½“éªŒæœ€ä½³

**ç¼ºç‚¹**:
- âš ï¸ éœ€è¦ç»´æŠ¤åŸŸåè§„åˆ™
- âš ï¸ å®ç°ç¨å¤æ‚

**é€‚ç”¨åœºæ™¯**:
- æ··åˆä½¿ç”¨å›½å†…å¤–æœåŠ¡
- è¿½æ±‚æœ€ä½³æ€§èƒ½

---

## ğŸš€ æ¨èæ–¹æ¡ˆ: HTTPä»£ç† + æ™ºèƒ½è·¯ç”±

ç»“åˆæ–¹æ¡ˆ1å’Œæ–¹æ¡ˆ4,å®ç°æœ€ä½³çš„ç”¨æˆ·ä½“éªŒã€‚

### æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  å‰ç«¯ (React)                    â”‚
â”‚  - ä»£ç†é…ç½®ç•Œé¢                                   â”‚
â”‚  - ä»£ç†çŠ¶æ€æ˜¾ç¤º                                   â”‚
â”‚  - æµ‹è¯•è¿æ¥åŠŸèƒ½                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              åç«¯ (Node.js)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚        ä»£ç†ç®¡ç†æ¨¡å— (ProxyManager)        â”‚  â”‚
â”‚  â”‚  - ä»£ç†é…ç½®å­˜å‚¨                           â”‚  â”‚
â”‚  â”‚  - ä»£ç†å¥åº·æ£€æŸ¥                           â”‚  â”‚
â”‚  â”‚  - æ™ºèƒ½è·¯ç”±è§„åˆ™                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚      HTTPå®¢æˆ·ç«¯åŒ…è£…å™¨ (ProxyClient)       â”‚  â”‚
â”‚  â”‚  - axioså®ä¾‹é…ç½®                          â”‚  â”‚
â”‚  â”‚  - è‡ªåŠ¨åº”ç”¨ä»£ç†                           â”‚  â”‚
â”‚  â”‚  - è¯·æ±‚é‡è¯•æœºåˆ¶                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚         MCPæœåŠ¡ (ä½¿ç”¨ProxyClient)         â”‚  â”‚
â”‚  â”‚  - Dexscreener                            â”‚  â”‚
â”‚  â”‚  - Playwright                             â”‚  â”‚
â”‚  â”‚  - å…¶ä»–éœ€è¦ä»£ç†çš„æœåŠ¡                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚             â”‚             â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”    â”Œâ”€â”€â”€â–¼â”€â”€â”€â”    â”Œâ”€â”€â”€â–¼â”€â”€â”€â”
â”‚ å›½å†…  â”‚    â”‚ ä»£ç†  â”‚    â”‚ å›½å¤–  â”‚
â”‚ API   â”‚    â”‚ æœåŠ¡  â”‚    â”‚ API   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”¬â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
            â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
            â”‚  å›½å¤–   â”‚
            â”‚  API    â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ å®ç°æ­¥éª¤

### æ­¥éª¤1: åˆ›å»ºä»£ç†ç®¡ç†æ¨¡å—

åˆ›å»º `server/lib/ProxyManager.cjs`:

```javascript
const fs = require('fs');
const path = require('path');
const axios = require('axios');
const { HttpsProxyAgent } = require('https-proxy-agent');
const { SocksProxyAgent } = require('socks-proxy-agent');

class ProxyManager {
  constructor() {
    this.configPath = path.join(__dirname, '../config/proxy.json');
    this.config = this.loadConfig();
    this.agent = null;
    this.initializeAgent();
  }

  /**
   * åŠ è½½ä»£ç†é…ç½®
   */
  loadConfig() {
    try {
      if (fs.existsSync(this.configPath)) {
        const data = fs.readFileSync(this.configPath, 'utf8');
        return JSON.parse(data);
      }
    } catch (error) {
      console.error('Failed to load proxy config:', error);
    }

    // é»˜è®¤é…ç½®
    return {
      enabled: false,
      type: 'http', // 'http', 'https', 'socks5'
      host: '127.0.0.1',
      port: 7890,
      username: '',
      password: '',
      bypassDomains: [
        // å›½å†…åŸŸå,ä¸ä½¿ç”¨ä»£ç†
        '*.cn',
        '*.com.cn',
        'localhost',
        '127.0.0.1',
        'baidu.com',
        'qq.com',
        'taobao.com',
        'aliyun.com',
        'bilibili.com',
        'douyin.com',
        'weibo.com',
      ],
      proxyDomains: [
        // éœ€è¦ä»£ç†çš„åŸŸå
        'dexscreener.com',
        'github.com',
        'googleapis.com',
        'cloudflare.com',
      ]
    };
  }

  /**
   * ä¿å­˜ä»£ç†é…ç½®
   */
  saveConfig(config) {
    try {
      const dir = path.dirname(this.configPath);
      if (!fs.existsSync(dir)) {
        fs.mkdirSync(dir, { recursive: true });
      }
      fs.writeFileSync(this.configPath, JSON.stringify(config, null, 2));
      this.config = config;
      this.initializeAgent();
      return true;
    } catch (error) {
      console.error('Failed to save proxy config:', error);
      return false;
    }
  }

  /**
   * åˆå§‹åŒ–ä»£ç†Agent
   */
  initializeAgent() {
    if (!this.config.enabled) {
      this.agent = null;
      return;
    }

    try {
      const { type, host, port, username, password } = this.config;
      
      let proxyUrl;
      if (username && password) {
        proxyUrl = `${type}://${username}:${password}@${host}:${port}`;
      } else {
        proxyUrl = `${type}://${host}:${port}`;
      }

      if (type === 'socks5') {
        this.agent = new SocksProxyAgent(proxyUrl);
      } else {
        this.agent = new HttpsProxyAgent(proxyUrl);
      }

      console.log(`âœ… Proxy agent initialized: ${type}://${host}:${port}`);
    } catch (error) {
      console.error('Failed to initialize proxy agent:', error);
      this.agent = null;
    }
  }

  /**
   * åˆ¤æ–­æ˜¯å¦éœ€è¦ä½¿ç”¨ä»£ç†
   */
  shouldUseProxy(url) {
    if (!this.config.enabled || !this.agent) {
      return false;
    }

    try {
      const urlObj = new URL(url);
      const hostname = urlObj.hostname;

      // æ£€æŸ¥æ˜¯å¦åœ¨ç»•è¿‡åˆ—è¡¨ä¸­
      for (const pattern of this.config.bypassDomains) {
        if (this.matchDomain(hostname, pattern)) {
          return false;
        }
      }

      // æ£€æŸ¥æ˜¯å¦åœ¨ä»£ç†åˆ—è¡¨ä¸­
      for (const pattern of this.config.proxyDomains) {
        if (this.matchDomain(hostname, pattern)) {
          return true;
        }
      }

      // é»˜è®¤ä¸ä½¿ç”¨ä»£ç†
      return false;
    } catch (error) {
      console.error('Error checking proxy:', error);
      return false;
    }
  }

  /**
   * åŸŸååŒ¹é…
   */
  matchDomain(hostname, pattern) {
    // ç²¾ç¡®åŒ¹é…
    if (hostname === pattern) {
      return true;
    }

    // é€šé…ç¬¦åŒ¹é…
    if (pattern.startsWith('*.')) {
      const suffix = pattern.slice(2);
      return hostname.endsWith(suffix) || hostname === suffix;
    }

    // åŒ…å«åŒ¹é…
    return hostname.includes(pattern);
  }

  /**
   * è·å–ä»£ç†Agent
   */
  getAgent(url) {
    if (this.shouldUseProxy(url)) {
      return this.agent;
    }
    return null;
  }

  /**
   * æµ‹è¯•ä»£ç†è¿æ¥
   */
  async testProxy() {
    if (!this.config.enabled) {
      return {
        success: false,
        message: 'ä»£ç†æœªå¯ç”¨'
      };
    }

    try {
      const testUrl = 'https://www.google.com';
      const response = await axios.get(testUrl, {
        httpsAgent: this.agent,
        timeout: 10000,
        validateStatus: () => true
      });

      if (response.status === 200) {
        return {
          success: true,
          message: 'ä»£ç†è¿æ¥æˆåŠŸ',
          latency: response.headers['x-response-time'] || 'N/A'
        };
      } else {
        return {
          success: false,
          message: `ä»£ç†è¿æ¥å¤±è´¥: HTTP ${response.status}`
        };
      }
    } catch (error) {
      return {
        success: false,
        message: `ä»£ç†è¿æ¥å¤±è´¥: ${error.message}`
      };
    }
  }

  /**
   * è·å–å½“å‰é…ç½®
   */
  getConfig() {
    // ä¸è¿”å›å¯†ç 
    const config = { ...this.config };
    if (config.password) {
      config.password = '******';
    }
    return config;
  }
}

// å•ä¾‹æ¨¡å¼
let instance = null;

function getProxyManager() {
  if (!instance) {
    instance = new ProxyManager();
  }
  return instance;
}

module.exports = { ProxyManager, getProxyManager };
```

---

### æ­¥éª¤2: åˆ›å»ºHTTPå®¢æˆ·ç«¯åŒ…è£…å™¨

åˆ›å»º `server/lib/ProxyClient.cjs`:

```javascript
const axios = require('axios');
const { getProxyManager } = require('./ProxyManager.cjs');

/**
 * åˆ›å»ºæ”¯æŒä»£ç†çš„axioså®ä¾‹
 */
function createProxyClient(baseURL = '', options = {}) {
  const proxyManager = getProxyManager();

  const client = axios.create({
    baseURL,
    timeout: options.timeout || 30000,
    ...options
  });

  // è¯·æ±‚æ‹¦æˆªå™¨ - è‡ªåŠ¨åº”ç”¨ä»£ç†
  client.interceptors.request.use(
    (config) => {
      const url = config.baseURL ? `${config.baseURL}${config.url}` : config.url;
      const agent = proxyManager.getAgent(url);
      
      if (agent) {
        config.httpsAgent = agent;
        config.httpAgent = agent;
        console.log(`ğŸŒ Using proxy for: ${url}`);
      } else {
        console.log(`ğŸ”— Direct connection for: ${url}`);
      }

      return config;
    },
    (error) => {
      return Promise.reject(error);
    }
  );

  // å“åº”æ‹¦æˆªå™¨ - é”™è¯¯å¤„ç†å’Œé‡è¯•
  client.interceptors.response.use(
    (response) => {
      return response;
    },
    async (error) => {
      const config = error.config;

      // å¦‚æœæ²¡æœ‰é‡è¯•é…ç½®,æ·»åŠ é»˜è®¤å€¼
      if (!config.__retryCount) {
        config.__retryCount = 0;
      }

      const maxRetries = options.maxRetries || 3;

      // å¦‚æœé‡è¯•æ¬¡æ•°æœªè¾¾åˆ°ä¸Šé™,è¿›è¡Œé‡è¯•
      if (config.__retryCount < maxRetries) {
        config.__retryCount += 1;
        console.log(`ğŸ”„ Retrying request (${config.__retryCount}/${maxRetries}): ${config.url}`);
        
        // å»¶è¿Ÿé‡è¯•
        await new Promise(resolve => setTimeout(resolve, 1000 * config.__retryCount));
        
        return client(config);
      }

      return Promise.reject(error);
    }
  );

  return client;
}

module.exports = { createProxyClient };
```

---

### æ­¥éª¤3: ä¿®æ”¹MCPæœåŠ¡ä½¿ç”¨ä»£ç†

ä¿®æ”¹ `server/services/dexscreener.cjs`:

```javascript
const { createProxyClient } = require('../lib/ProxyClient.cjs');

class DexscreenerService extends BaseService {
  constructor() {
    super('dexscreener', 'DexscreeneråŠ å¯†è´§å¸', 'è·å–å®æ—¶åŠ å¯†è´§å¸ä»·æ ¼å’Œå¸‚åœºæ•°æ®');
    
    // ä½¿ç”¨æ”¯æŒä»£ç†çš„å®¢æˆ·ç«¯
    this.client = createProxyClient('https://api.dexscreener.com/latest', {
      timeout: 15000,
      maxRetries: 3
    });
  }

  async searchToken(query) {
    try {
      const response = await this.client.get(`/dex/search?q=${encodeURIComponent(query)}`);
      return response.data;
    } catch (error) {
      console.error('Dexscreener search error:', error.message);
      throw new Error(`æœç´¢å¤±è´¥: ${error.message}`);
    }
  }

  // ... å…¶ä»–æ–¹æ³•
}
```

---

### æ­¥éª¤4: æ·»åŠ ä»£ç†é…ç½®API

åœ¨ `server/routes/proxy.cjs` ä¸­æ·»åŠ :

```javascript
const express = require('express');
const router = express.Router();
const { getProxyManager } = require('../lib/ProxyManager.cjs');

/**
 * è·å–ä»£ç†é…ç½®
 */
router.get('/config', (req, res) => {
  try {
    const proxyManager = getProxyManager();
    const config = proxyManager.getConfig();
    res.json({ success: true, config });
  } catch (error) {
    res.status(500).json({ success: false, error: error.message });
  }
});

/**
 * æ›´æ–°ä»£ç†é…ç½®
 */
router.post('/config', (req, res) => {
  try {
    const proxyManager = getProxyManager();
    const success = proxyManager.saveConfig(req.body);
    
    if (success) {
      res.json({ success: true, message: 'ä»£ç†é…ç½®å·²ä¿å­˜' });
    } else {
      res.status(500).json({ success: false, error: 'ä¿å­˜å¤±è´¥' });
    }
  } catch (error) {
    res.status(500).json({ success: false, error: error.message });
  }
});

/**
 * æµ‹è¯•ä»£ç†è¿æ¥
 */
router.post('/test', async (req, res) => {
  try {
    const proxyManager = getProxyManager();
    const result = await proxyManager.testProxy();
    res.json(result);
  } catch (error) {
    res.status(500).json({ success: false, error: error.message });
  }
});

/**
 * å¯ç”¨/ç¦ç”¨ä»£ç†
 */
router.post('/toggle', (req, res) => {
  try {
    const { enabled } = req.body;
    const proxyManager = getProxyManager();
    const config = proxyManager.getConfig();
    config.enabled = enabled;
    proxyManager.saveConfig(config);
    
    res.json({ 
      success: true, 
      message: enabled ? 'ä»£ç†å·²å¯ç”¨' : 'ä»£ç†å·²ç¦ç”¨',
      enabled 
    });
  } catch (error) {
    res.status(500).json({ success: false, error: error.message });
  }
});

module.exports = router;
```

åœ¨ `server/index.cjs` ä¸­æ³¨å†Œè·¯ç”±:

```javascript
const proxyRoutes = require('./routes/proxy.cjs');
app.use('/api/proxy', proxyRoutes);
```

---

### æ­¥éª¤5: åˆ›å»ºå‰ç«¯ä»£ç†é…ç½®ç•Œé¢

åˆ›å»º `src/components/proxy/ProxyConfig.jsx`:

```jsx
import { useState, useEffect } from 'react'
import { Settings, Wifi, WifiOff, CheckCircle, XCircle, Loader } from 'lucide-react'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Switch } from '@/components/ui/switch'
import { Select } from '@/components/ui/select'
import { Alert, AlertDescription } from '@/components/ui/alert'

export default function ProxyConfig() {
  const [config, setConfig] = useState({
    enabled: false,
    type: 'http',
    host: '127.0.0.1',
    port: 7890,
    username: '',
    password: ''
  })

  const [testing, setTesting] = useState(false)
  const [testResult, setTestResult] = useState(null)
  const [saving, setSaving] = useState(false)

  // åŠ è½½é…ç½®
  useEffect(() => {
    loadConfig()
  }, [])

  const loadConfig = async () => {
    try {
      const response = await fetch('/api/proxy/config')
      const data = await response.json()
      if (data.success) {
        setConfig(data.config)
      }
    } catch (error) {
      console.error('Failed to load proxy config:', error)
    }
  }

  // ä¿å­˜é…ç½®
  const handleSave = async () => {
    setSaving(true)
    try {
      const response = await fetch('/api/proxy/config', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(config)
      })
      const data = await response.json()
      
      if (data.success) {
        alert('ä»£ç†é…ç½®å·²ä¿å­˜')
      } else {
        alert('ä¿å­˜å¤±è´¥: ' + data.error)
      }
    } catch (error) {
      alert('ä¿å­˜å¤±è´¥: ' + error.message)
    } finally {
      setSaving(false)
    }
  }

  // æµ‹è¯•è¿æ¥
  const handleTest = async () => {
    setTesting(true)
    setTestResult(null)
    
    try {
      const response = await fetch('/api/proxy/test', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      })
      const data = await response.json()
      setTestResult(data)
    } catch (error) {
      setTestResult({
        success: false,
        message: 'æµ‹è¯•å¤±è´¥: ' + error.message
      })
    } finally {
      setTesting(false)
    }
  }

  // åˆ‡æ¢å¯ç”¨çŠ¶æ€
  const handleToggle = async (enabled) => {
    try {
      const response = await fetch('/api/proxy/toggle', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ enabled })
      })
      const data = await response.json()
      
      if (data.success) {
        setConfig({ ...config, enabled })
      }
    } catch (error) {
      console.error('Failed to toggle proxy:', error)
    }
  }

  return (
    <div className="space-y-6 p-6">
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-3">
          <Settings className="w-6 h-6" />
          <div>
            <h2 className="text-xl font-semibold">ä»£ç†è®¾ç½®</h2>
            <p className="text-sm text-gray-600">
              é…ç½®ä»£ç†æœåŠ¡å™¨ä»¥è®¿é—®å›½å¤–API
            </p>
          </div>
        </div>
        
        <div className="flex items-center gap-2">
          <span className="text-sm text-gray-600">
            {config.enabled ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨'}
          </span>
          <Switch
            checked={config.enabled}
            onCheckedChange={handleToggle}
          />
        </div>
      </div>

      {/* ä»£ç†ç±»å‹ */}
      <div className="space-y-2">
        <Label>ä»£ç†ç±»å‹</Label>
        <Select
          value={config.type}
          onChange={(e) => setConfig({ ...config, type: e.target.value })}
        >
          <option value="http">HTTP</option>
          <option value="https">HTTPS</option>
          <option value="socks5">SOCKS5</option>
        </Select>
      </div>

      {/* ä»£ç†åœ°å€ */}
      <div className="grid grid-cols-2 gap-4">
        <div className="space-y-2">
          <Label>ä¸»æœºåœ°å€</Label>
          <Input
            type="text"
            placeholder="127.0.0.1"
            value={config.host}
            onChange={(e) => setConfig({ ...config, host: e.target.value })}
          />
        </div>
        
        <div className="space-y-2">
          <Label>ç«¯å£</Label>
          <Input
            type="number"
            placeholder="7890"
            value={config.port}
            onChange={(e) => setConfig({ ...config, port: parseInt(e.target.value) })}
          />
        </div>
      </div>

      {/* è®¤è¯ä¿¡æ¯ (å¯é€‰) */}
      <div className="grid grid-cols-2 gap-4">
        <div className="space-y-2">
          <Label>ç”¨æˆ·å (å¯é€‰)</Label>
          <Input
            type="text"
            placeholder="username"
            value={config.username}
            onChange={(e) => setConfig({ ...config, username: e.target.value })}
          />
        </div>
        
        <div className="space-y-2">
          <Label>å¯†ç  (å¯é€‰)</Label>
          <Input
            type="password"
            placeholder="password"
            value={config.password}
            onChange={(e) => setConfig({ ...config, password: e.target.value })}
          />
        </div>
      </div>

      {/* æµ‹è¯•ç»“æœ */}
      {testResult && (
        <Alert variant={testResult.success ? 'success' : 'destructive'}>
          <div className="flex items-center gap-2">
            {testResult.success ? (
              <CheckCircle className="w-5 h-5 text-green-600" />
            ) : (
              <XCircle className="w-5 h-5 text-red-600" />
            )}
            <AlertDescription>{testResult.message}</AlertDescription>
          </div>
        </Alert>
      )}

      {/* æ“ä½œæŒ‰é’® */}
      <div className="flex gap-3">
        <Button onClick={handleTest} disabled={testing || !config.enabled}>
          {testing ? (
            <>
              <Loader className="w-4 h-4 mr-2 animate-spin" />
              æµ‹è¯•ä¸­...
            </>
          ) : (
            <>
              <Wifi className="w-4 h-4 mr-2" />
              æµ‹è¯•è¿æ¥
            </>
          )}
        </Button>
        
        <Button onClick={handleSave} disabled={saving} variant="primary">
          {saving ? (
            <>
              <Loader className="w-4 h-4 mr-2 animate-spin" />
              ä¿å­˜ä¸­...
            </>
          ) : (
            'ä¿å­˜é…ç½®'
          )}
        </Button>
      </div>

      {/* ä½¿ç”¨è¯´æ˜ */}
      <div className="mt-6 p-4 bg-blue-50 rounded-lg">
        <h3 className="font-medium mb-2">ğŸ’¡ ä½¿ç”¨è¯´æ˜</h3>
        <ul className="text-sm text-gray-700 space-y-1">
          <li>â€¢ å¦‚æœæ‚¨ä½¿ç”¨Clash,ä»£ç†åœ°å€é€šå¸¸æ˜¯ <code>127.0.0.1:7890</code></li>
          <li>â€¢ å¦‚æœæ‚¨ä½¿ç”¨V2Ray,ä»£ç†åœ°å€é€šå¸¸æ˜¯ <code>127.0.0.1:10808</code></li>
          <li>â€¢ å¯ç”¨ä»£ç†å,Dexscreenerç­‰å›½å¤–æœåŠ¡å°†è‡ªåŠ¨é€šè¿‡ä»£ç†è®¿é—®</li>
          <li>â€¢ å›½å†…æœåŠ¡(å¦‚å¤©æ°”ã€æ—¶é—´)ä¼šè‡ªåŠ¨ç›´è¿,ä¸ä½¿ç”¨ä»£ç†</li>
          <li>â€¢ å»ºè®®å…ˆæµ‹è¯•è¿æ¥,ç¡®ä¿ä»£ç†å¯ç”¨åå†ä¿å­˜</li>
        </ul>
      </div>
    </div>
  )
}
```

---

### æ­¥éª¤6: å°†ä»£ç†é…ç½®æ·»åŠ åˆ°è®¾ç½®é¡µé¢

ä¿®æ”¹ `src/components/settings/SettingsPage.jsx`:

```jsx
import ProxyConfig from '@/components/proxy/ProxyConfig'

// åœ¨è®¾ç½®æ ‡ç­¾ä¸­æ·»åŠ 
<Tabs.List>
  <Tabs.Trigger value="model">æ¨¡å‹é…ç½®</Tabs.Trigger>
  <Tabs.Trigger value="prompt">System Prompt</Tabs.Trigger>
  <Tabs.Trigger value="mcp">MCP Services</Tabs.Trigger>
  <Tabs.Trigger value="proxy">ä»£ç†è®¾ç½®</Tabs.Trigger> {/* æ–°å¢ */}
  <Tabs.Trigger value="appearance">å¤–è§‚</Tabs.Trigger>
  <Tabs.Trigger value="language">è¯­è¨€</Tabs.Trigger>
</Tabs.List>

// åœ¨å†…å®¹åŒºåŸŸæ·»åŠ 
<Tabs.Content value="proxy">
  <ProxyConfig />
</Tabs.Content>
```

---

### æ­¥éª¤7: å®‰è£…å¿…è¦çš„ä¾èµ–

```bash
cd Personal Chatbox

# å®‰è£…ä»£ç†ç›¸å…³ä¾èµ–
npm install https-proxy-agent socks-proxy-agent --save
```

---

## ğŸ¨ é…ç½®ç•Œé¢é¢„è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âš™ï¸  ä»£ç†è®¾ç½®                      [å¯ç”¨] â—      â”‚
â”‚  é…ç½®ä»£ç†æœåŠ¡å™¨ä»¥è®¿é—®å›½å¤–API                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                  â”‚
â”‚  ä»£ç†ç±»å‹:  [HTTP â–¼]                             â”‚
â”‚                                                  â”‚
â”‚  ä¸»æœºåœ°å€:  [127.0.0.1        ]  ç«¯å£: [7890  ] â”‚
â”‚                                                  â”‚
â”‚  ç”¨æˆ·å:    [                 ]  (å¯é€‰)          â”‚
â”‚  å¯†ç :      [                 ]  (å¯é€‰)          â”‚
â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ âœ… ä»£ç†è¿æ¥æˆåŠŸ                           â”‚  â”‚
â”‚  â”‚    å»¶è¿Ÿ: 120ms                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                  â”‚
â”‚  [ğŸŒ æµ‹è¯•è¿æ¥]  [ğŸ’¾ ä¿å­˜é…ç½®]                    â”‚
â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ğŸ’¡ ä½¿ç”¨è¯´æ˜                               â”‚  â”‚
â”‚  â”‚ â€¢ Clashä»£ç†: 127.0.0.1:7890              â”‚  â”‚
â”‚  â”‚ â€¢ V2Rayä»£ç†: 127.0.0.1:10808             â”‚  â”‚
â”‚  â”‚ â€¢ å›½å¤–æœåŠ¡è‡ªåŠ¨ä½¿ç”¨ä»£ç†                     â”‚  â”‚
â”‚  â”‚ â€¢ å›½å†…æœåŠ¡è‡ªåŠ¨ç›´è¿                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”’ å®‰å…¨è€ƒè™‘

### 1. å¯†ç åŠ å¯†å­˜å‚¨

```javascript
const crypto = require('crypto');

// åŠ å¯†å¯†ç 
function encryptPassword(password) {
  const algorithm = 'aes-256-cbc';
  const key = crypto.scryptSync(process.env.SECRET_KEY || 'default-key', 'salt', 32);
  const iv = crypto.randomBytes(16);
  
  const cipher = crypto.createCipheriv(algorithm, key, iv);
  let encrypted = cipher.update(password, 'utf8', 'hex');
  encrypted += cipher.final('hex');
  
  return iv.toString('hex') + ':' + encrypted;
}

// è§£å¯†å¯†ç 
function decryptPassword(encrypted) {
  const algorithm = 'aes-256-cbc';
  const key = crypto.scryptSync(process.env.SECRET_KEY || 'default-key', 'salt', 32);
  
  const parts = encrypted.split(':');
  const iv = Buffer.from(parts[0], 'hex');
  const encryptedText = parts[1];
  
  const decipher = crypto.createDecipheriv(algorithm, key, iv);
  let decrypted = decipher.update(encryptedText, 'hex', 'utf8');
  decrypted += decipher.final('utf8');
  
  return decrypted;
}
```

### 2. é…ç½®æ–‡ä»¶æƒé™

```javascript
// è®¾ç½®é…ç½®æ–‡ä»¶æƒé™ä¸º600 (ä»…æ‰€æœ‰è€…å¯è¯»å†™)
fs.chmodSync(this.configPath, 0o600);
```

### 3. ç¯å¢ƒå˜é‡

```bash
# .env
SECRET_KEY=your-secret-key-here
PROXY_CONFIG_PATH=/path/to/secure/location/proxy.json
```

---

## âœ… æµ‹è¯•éªŒè¯

### æµ‹è¯•è„šæœ¬

åˆ›å»º `server/test/proxy-test.cjs`:

```javascript
const { getProxyManager } = require('../lib/ProxyManager.cjs');
const { createProxyClient } = require('../lib/ProxyClient.cjs');

async function testProxy() {
  console.log('ğŸ§ª å¼€å§‹æµ‹è¯•ä»£ç†åŠŸèƒ½...\n');

  const proxyManager = getProxyManager();

  // æµ‹è¯•1: é…ç½®åŠ è½½
  console.log('1ï¸âƒ£ æµ‹è¯•é…ç½®åŠ è½½');
  const config = proxyManager.getConfig();
  console.log('   é…ç½®:', JSON.stringify(config, null, 2));
  console.log('   âœ… é…ç½®åŠ è½½æˆåŠŸ\n');

  // æµ‹è¯•2: åŸŸååŒ¹é…
  console.log('2ï¸âƒ£ æµ‹è¯•åŸŸååŒ¹é…');
  const testUrls = [
    'https://dexscreener.com/api',
    'https://api.github.com',
    'https://www.baidu.com',
    'https://api.bilibili.com',
  ];

  for (const url of testUrls) {
    const shouldProxy = proxyManager.shouldUseProxy(url);
    console.log(`   ${url}`);
    console.log(`   ${shouldProxy ? 'ğŸŒ ä½¿ç”¨ä»£ç†' : 'ğŸ”— ç›´æ¥è¿æ¥'}`);
  }
  console.log('   âœ… åŸŸååŒ¹é…æµ‹è¯•å®Œæˆ\n');

  // æµ‹è¯•3: ä»£ç†è¿æ¥
  console.log('3ï¸âƒ£ æµ‹è¯•ä»£ç†è¿æ¥');
  const result = await proxyManager.testProxy();
  console.log('   ç»“æœ:', result);
  console.log(result.success ? '   âœ… ä»£ç†è¿æ¥æˆåŠŸ\n' : '   âŒ ä»£ç†è¿æ¥å¤±è´¥\n');

  // æµ‹è¯•4: HTTPå®¢æˆ·ç«¯
  console.log('4ï¸âƒ£ æµ‹è¯•HTTPå®¢æˆ·ç«¯');
  const client = createProxyClient();
  
  try {
    const response = await client.get('https://api.github.com');
    console.log('   GitHub APIå“åº”çŠ¶æ€:', response.status);
    console.log('   âœ… HTTPå®¢æˆ·ç«¯æµ‹è¯•æˆåŠŸ\n');
  } catch (error) {
    console.log('   âŒ HTTPå®¢æˆ·ç«¯æµ‹è¯•å¤±è´¥:', error.message, '\n');
  }

  console.log('ğŸ‰ æµ‹è¯•å®Œæˆ!');
}

testProxy().catch(console.error);
```

è¿è¡Œæµ‹è¯•:

```bash
node server/test/proxy-test.cjs
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### 1. è¿æ¥æ± 

```javascript
const agent = new HttpsProxyAgent(proxyUrl, {
  keepAlive: true,
  keepAliveMsecs: 1000,
  maxSockets: 256,
  maxFreeSockets: 256,
  scheduling: 'lifo',
  timeout: 60000
});
```

### 2. è¯·æ±‚ç¼“å­˜

```javascript
const cache = new Map();

function getCachedResponse(url, ttl = 60000) {
  const cached = cache.get(url);
  if (cached && Date.now() - cached.timestamp < ttl) {
    return cached.data;
  }
  return null;
}

function setCachedResponse(url, data) {
  cache.set(url, {
    data,
    timestamp: Date.now()
  });
}
```

### 3. å¹¶å‘æ§åˆ¶

```javascript
const pLimit = require('p-limit');
const limit = pLimit(10); // æœ€å¤š10ä¸ªå¹¶å‘è¯·æ±‚

const promises = urls.map(url => 
  limit(() => client.get(url))
);

const results = await Promise.all(promises);
```

---

## ğŸ¯ æ€»ç»“

### ä¼˜åŠ¿

1. âœ… **ç”¨æˆ·å‹å¥½**: å›¾å½¢åŒ–é…ç½®ç•Œé¢,æ— éœ€æ‰‹åŠ¨ç¼–è¾‘æ–‡ä»¶
2. âœ… **æ™ºèƒ½è·¯ç”±**: è‡ªåŠ¨åˆ¤æ–­æ˜¯å¦éœ€è¦ä»£ç†,èŠ‚çœæµé‡
3. âœ… **å®‰å…¨å¯é **: å¯†ç åŠ å¯†å­˜å‚¨,é…ç½®æ–‡ä»¶æƒé™æ§åˆ¶
4. âœ… **æ€§èƒ½ä¼˜åŒ–**: è¿æ¥æ± ã€ç¼“å­˜ã€å¹¶å‘æ§åˆ¶
5. âœ… **æ˜“äºç»´æŠ¤**: æ¨¡å—åŒ–è®¾è®¡,ä»£ç æ¸…æ™°

### ä½¿ç”¨åœºæ™¯

- âœ… ç”¨æˆ·å·²æœ‰Clashã€V2Rayç­‰ä»£ç†å·¥å…·
- âœ… éœ€è¦è®¿é—®Dexscreenerç­‰å›½å¤–API
- âœ… å¸Œæœ›å›½å†…æœåŠ¡ç›´è¿,å›½å¤–æœåŠ¡èµ°ä»£ç†
- âœ… éœ€è¦çµæ´»é…ç½®ä»£ç†è§„åˆ™

### åç»­ä¼˜åŒ–

1. æ”¯æŒPACè‡ªåŠ¨ä»£ç†é…ç½®
2. æ”¯æŒå¤šä¸ªä»£ç†æœåŠ¡å™¨è´Ÿè½½å‡è¡¡
3. æ·»åŠ ä»£ç†æœåŠ¡å™¨å»¶è¿Ÿæµ‹è¯•å’Œè‡ªåŠ¨é€‰æ‹©
4. æ”¯æŒè®¢é˜…é“¾æ¥å¯¼å…¥
5. æ·»åŠ æµé‡ç»Ÿè®¡åŠŸèƒ½

---

**å®æ–½è¿™ä¸ªæ–¹æ¡ˆå,æ‰€æœ‰MCPæœåŠ¡éƒ½èƒ½æ­£å¸¸è®¿é—®å›½å¤–API,åŒæ—¶ä¿æŒå›½å†…æœåŠ¡çš„é«˜é€Ÿè®¿é—®!** ğŸš€

