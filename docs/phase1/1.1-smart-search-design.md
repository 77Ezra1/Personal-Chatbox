# Phase 1.1: æ™ºèƒ½æœç´¢ä¸Žè¿‡æ»¤ - è¯¦ç»†è®¾è®¡

## ðŸ“‹ åŠŸèƒ½æ¦‚è¿°

ä¸º Personal Chatbox æ·»åŠ å¼ºå¤§çš„æœç´¢åŠŸèƒ½ï¼Œè®©ç”¨æˆ·å¿«é€Ÿæ‰¾åˆ°åŽ†å²å¯¹è¯ã€‚

## ðŸŽ¯ æ ¸å¿ƒåŠŸèƒ½

### 1. æœç´¢åŠŸèƒ½
- å…¨æ–‡æœç´¢ï¼ˆæ ‡é¢˜ + æ¶ˆæ¯å†…å®¹ï¼‰
- å®žæ—¶æœç´¢ï¼ˆè¾“å…¥æ—¶å³æ—¶æ˜¾ç¤ºç»“æžœï¼‰
- æœç´¢ç»“æžœé«˜äº®
- æœç´¢åŽ†å²è®°å½•

### 2. é«˜çº§è¿‡æ»¤
- æ—¥æœŸèŒƒå›´è¿‡æ»¤
- æ¨¡åž‹è¿‡æ»¤ï¼ˆæŒ‰ä½¿ç”¨çš„ AI æ¨¡åž‹ï¼‰
- æ ‡ç­¾è¿‡æ»¤ï¼ˆPhase 1.4 å®ŒæˆåŽï¼‰
- æ¶ˆæ¯æ•°é‡è¿‡æ»¤

### 3. æŽ’åºåŠŸèƒ½
- æŒ‰ç›¸å…³åº¦æŽ’åº
- æŒ‰æ—¶é—´æŽ’åºï¼ˆæœ€æ–°/æœ€æ—§ï¼‰
- æŒ‰æ¶ˆæ¯æ•°é‡æŽ’åº

## ðŸ—ï¸ æž¶æž„è®¾è®¡

### å‰ç«¯ç»„ä»¶ç»“æž„
```
src/components/sidebar/
â”œâ”€â”€ SearchBar.jsx              # æœç´¢è¾“å…¥æ¡†
â”œâ”€â”€ AdvancedFilter.jsx         # é«˜çº§è¿‡æ»¤å™¨é¢æ¿
â”œâ”€â”€ SearchResults.jsx          # æœç´¢ç»“æžœå±•ç¤º
â””â”€â”€ Sidebar.jsx                # ä¿®æ”¹ï¼šé›†æˆæœç´¢åŠŸèƒ½
```

### åŽç«¯ API
```
GET /api/conversations/search
Query Parameters:
  - q: æœç´¢å…³é”®è¯
  - from: å¼€å§‹æ—¥æœŸ (YYYY-MM-DD)
  - to: ç»“æŸæ—¥æœŸ (YYYY-MM-DD)
  - model: æ¨¡åž‹ç­›é€‰
  - sort: æŽ’åºæ–¹å¼ (relevance/date/messages)
  - order: æŽ’åºæ–¹å‘ (asc/desc)
  - limit: è¿”å›žæ•°é‡é™åˆ¶
  - offset: åˆ†é¡µåç§»
```

### æ•°æ®æµ
```
ç”¨æˆ·è¾“å…¥ â†’ å‰ç«¯é˜²æŠ– (300ms) â†’ API è¯·æ±‚ â†’
åŽç«¯æœç´¢ (SQLite FTS) â†’ è¿”å›žç»“æžœ â†’ å‰ç«¯å±•ç¤º + é«˜äº®
```

## ðŸ—„ï¸ æ•°æ®åº“æ”¹åŠ¨

### å¯ç”¨ SQLite FTSï¼ˆå…¨æ–‡æœç´¢ï¼‰

```sql
-- åˆ›å»ºè™šæ‹Ÿè¡¨ç”¨äºŽå…¨æ–‡æœç´¢
CREATE VIRTUAL TABLE conversations_fts USING fts5(
  id UNINDEXED,
  title,
  content,
  tokenize='porter unicode61'
);

-- åˆ›å»ºè§¦å‘å™¨ï¼šæ–°å¢žå¯¹è¯æ—¶åŒæ­¥åˆ° FTS è¡¨
CREATE TRIGGER conversations_fts_insert AFTER INSERT ON conversations
BEGIN
  INSERT INTO conversations_fts(id, title, content)
  SELECT
    NEW.id,
    NEW.title,
    COALESCE(
      (SELECT GROUP_CONCAT(content, ' ')
       FROM messages
       WHERE conversation_id = NEW.id),
      ''
    );
END;

-- åˆ›å»ºè§¦å‘å™¨ï¼šæ›´æ–°å¯¹è¯æ—¶åŒæ­¥åˆ° FTS è¡¨
CREATE TRIGGER conversations_fts_update AFTER UPDATE ON conversations
BEGIN
  UPDATE conversations_fts
  SET title = NEW.title
  WHERE id = NEW.id;
END;

-- åˆ›å»ºè§¦å‘å™¨ï¼šåˆ é™¤å¯¹è¯æ—¶æ¸…ç† FTS è¡¨
CREATE TRIGGER conversations_fts_delete AFTER DELETE ON conversations
BEGIN
  DELETE FROM conversations_fts WHERE id = OLD.id;
END;

-- åˆ›å»ºè§¦å‘å™¨ï¼šæ¶ˆæ¯å˜åŒ–æ—¶æ›´æ–° FTS å†…å®¹
CREATE TRIGGER messages_fts_sync AFTER INSERT ON messages
BEGIN
  UPDATE conversations_fts
  SET content = (
    SELECT GROUP_CONCAT(content, ' ')
    FROM messages
    WHERE conversation_id = NEW.conversation_id
  )
  WHERE id = NEW.conversation_id;
END;
```

### ç´¢å¼•ä¼˜åŒ–

```sql
-- ä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µæ·»åŠ ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_conversations_created_at
  ON conversations(created_at DESC);

CREATE INDEX IF NOT EXISTS idx_conversations_user_created
  ON conversations(user_id, created_at DESC);

CREATE INDEX IF NOT EXISTS idx_messages_conversation
  ON messages(conversation_id, timestamp);
```

## ðŸ’» å‰ç«¯å®žçŽ°

### 1. SearchBar ç»„ä»¶

**åŠŸèƒ½**ï¼š
- æœç´¢è¾“å…¥æ¡†
- å®žæ—¶æœç´¢ï¼ˆé˜²æŠ–ï¼‰
- æ¸…ç©ºæŒ‰é’®
- æœç´¢åŽ†å²ä¸‹æ‹‰

**çŠ¶æ€ç®¡ç†**ï¼š
```javascript
const [searchQuery, setSearchQuery] = useState('')
const [searchHistory, setSearchHistory] = useState([])
const [isSearching, setIsSearching] = useState(false)
```

### 2. AdvancedFilter ç»„ä»¶

**åŠŸèƒ½**ï¼š
- æ—¥æœŸé€‰æ‹©å™¨ï¼ˆä½¿ç”¨ react-day-pickerï¼‰
- æ¨¡åž‹å¤šé€‰ï¼ˆCheckboxï¼‰
- æŽ’åºé€‰é¡¹ï¼ˆSelectï¼‰
- é‡ç½®æŒ‰é’®

**çŠ¶æ€ç®¡ç†**ï¼š
```javascript
const [filters, setFilters] = useState({
  dateFrom: null,
  dateTo: null,
  models: [],
  sort: 'relevance',
  order: 'desc'
})
```

### 3. æœç´¢ç»“æžœå±•ç¤º

**åŠŸèƒ½**ï¼š
- ç»“æžœåˆ—è¡¨ï¼ˆå¤ç”¨ ConversationItemï¼‰
- å…³é”®è¯é«˜äº®
- æ— ç»“æžœæç¤º
- åŠ è½½çŠ¶æ€

## ðŸ”§ æŠ€æœ¯å®žçŽ°ç»†èŠ‚

### å‰ç«¯æœç´¢ä¼˜åŒ–

1. **é˜²æŠ–å¤„ç†**
```javascript
import { useDebouncedCallback } from 'use-debounce'

const debouncedSearch = useDebouncedCallback(
  (query) => {
    performSearch(query)
  },
  300 // 300ms å»¶è¿Ÿ
)
```

2. **å…³é”®è¯é«˜äº®**
```javascript
const highlightText = (text, query) => {
  if (!query) return text
  const regex = new RegExp(`(${query})`, 'gi')
  return text.replace(regex, '<mark>$1</mark>')
}
```

3. **æœç´¢åŽ†å²æŒä¹…åŒ–**
```javascript
// ä½¿ç”¨ localStorage å­˜å‚¨
const saveSearchHistory = (query) => {
  const history = JSON.parse(localStorage.getItem('searchHistory') || '[]')
  const updated = [query, ...history.filter(q => q !== query)].slice(0, 10)
  localStorage.setItem('searchHistory', JSON.stringify(updated))
}
```

### åŽç«¯æœç´¢å®žçŽ°

1. **FTS æŸ¥è¯¢**
```javascript
// ä½¿ç”¨ SQLite FTS5 è¿›è¡Œå…¨æ–‡æœç´¢
const searchConversations = (userId, query, filters) => {
  let sql = `
    SELECT
      c.id,
      c.title,
      c.created_at,
      c.updated_at,
      COUNT(m.id) as message_count,
      snippet(conversations_fts, 1, '<mark>', '</mark>', '...', 50) as snippet
    FROM conversations c
    LEFT JOIN conversations_fts fts ON c.id = fts.id
    LEFT JOIN messages m ON c.id = m.conversation_id
    WHERE c.user_id = ?
  `

  const params = [userId]

  if (query) {
    sql += ` AND fts.conversations_fts MATCH ?`
    params.push(query)
  }

  // æ·»åŠ æ—¥æœŸè¿‡æ»¤
  if (filters.dateFrom) {
    sql += ` AND c.created_at >= ?`
    params.push(filters.dateFrom)
  }

  if (filters.dateTo) {
    sql += ` AND c.created_at <= ?`
    params.push(filters.dateTo)
  }

  // åˆ†ç»„
  sql += ` GROUP BY c.id`

  // æŽ’åº
  if (filters.sort === 'relevance' && query) {
    sql += ` ORDER BY rank`
  } else if (filters.sort === 'date') {
    sql += ` ORDER BY c.created_at ${filters.order}`
  } else if (filters.sort === 'messages') {
    sql += ` ORDER BY message_count ${filters.order}`
  }

  // åˆ†é¡µ
  sql += ` LIMIT ? OFFSET ?`
  params.push(filters.limit || 20, filters.offset || 0)

  return db.all(sql, params)
}
```

2. **ç¼“å­˜ç­–ç•¥**
```javascript
// ä½¿ç”¨ç®€å•çš„å†…å­˜ç¼“å­˜
const searchCache = new Map()
const CACHE_TTL = 60000 // 1åˆ†é’Ÿ

const getCachedSearch = (cacheKey) => {
  const cached = searchCache.get(cacheKey)
  if (cached && Date.now() - cached.timestamp < CACHE_TTL) {
    return cached.data
  }
  return null
}
```

## ðŸŽ¨ UI/UX è®¾è®¡

### æœç´¢æ æ ·å¼
- å›¾æ ‡ï¼šæ”¾å¤§é•œ (Search)
- ä½ç½®ï¼šSidebar é¡¶éƒ¨ï¼Œå¯¹è¯åˆ—è¡¨ä¸Šæ–¹
- æ ·å¼ï¼šApple é£Žæ ¼åœ†è§’è¾“å…¥æ¡†
- å¿«æ·é”®ï¼šCmd/Ctrl + K èšç„¦æœç´¢æ¡†

### é«˜çº§è¿‡æ»¤å™¨
- å±•å¼€/æ”¶èµ·æŒ‰é’®ï¼ˆFilter å›¾æ ‡ï¼‰
- é¢æ¿ï¼šPopover æˆ– Collapsible
- æ ·å¼ï¼šç®€æ´çš„è¡¨å•å¸ƒå±€

### æœç´¢ç»“æžœ
- é«˜äº®ï¼šé»„è‰²èƒŒæ™¯æ ‡è®°
- æ‘˜è¦ï¼šæ˜¾ç¤ºåŒ¹é…çš„ä¸Šä¸‹æ–‡ç‰‡æ®µ
- ç©ºçŠ¶æ€ï¼šå‹å¥½çš„æç¤º + æœç´¢å»ºè®®

## ðŸ“± å“åº”å¼è®¾è®¡

### ç§»åŠ¨ç«¯é€‚é…
- æœç´¢æ ï¼šå…¨å®½æ˜¾ç¤º
- è¿‡æ»¤å™¨ï¼šåº•éƒ¨æŠ½å±‰å±•ç¤º
- ç»“æžœåˆ—è¡¨ï¼šå•åˆ—å¸ƒå±€

## âš¡ æ€§èƒ½ä¼˜åŒ–

1. **é˜²æŠ–å’ŒèŠ‚æµ**ï¼šé¿å…é¢‘ç¹ API è¯·æ±‚
2. **è™šæ‹Ÿåˆ—è¡¨**ï¼šå¤§é‡ç»“æžœæ—¶ä½¿ç”¨è™šæ‹Ÿæ»šåŠ¨
3. **æ‡’åŠ è½½**ï¼šç»“æžœåˆ†é¡µåŠ è½½
4. **FTS ç´¢å¼•**ï¼šåˆ©ç”¨ SQLite å…¨æ–‡æœç´¢åŠ é€Ÿ
5. **ç¼“å­˜**ï¼šç›¸åŒæœç´¢å¤ç”¨ç»“æžœ

## ðŸ§ª æµ‹è¯•ç”¨ä¾‹

### åŠŸèƒ½æµ‹è¯•
1. æœç´¢ç©ºå­—ç¬¦ä¸² â†’ æ˜¾ç¤ºæ‰€æœ‰å¯¹è¯
2. æœç´¢å…³é”®è¯ â†’ è¿”å›žåŒ¹é…ç»“æžœ
3. ä½¿ç”¨è¿‡æ»¤å™¨ â†’ æ­£ç¡®ç­›é€‰
4. æŽ’åºåŠŸèƒ½ â†’ ç»“æžœæ­£ç¡®æŽ’åº
5. åˆ†é¡µåŠŸèƒ½ â†’ åŠ è½½æ›´å¤šç»“æžœ

### è¾¹ç•Œæµ‹è¯•
1. ç‰¹æ®Šå­—ç¬¦æœç´¢
2. è¶…é•¿å…³é”®è¯
3. æ— ç»“æžœæƒ…å†µ
4. ç½‘ç»œé”™è¯¯å¤„ç†

## ðŸ“¦ ä¾èµ–åŒ…

```json
{
  "dependencies": {
    "use-debounce": "^10.0.0",  // é˜²æŠ– Hook
    "date-fns": "^4.1.0"        // å·²å®‰è£…ï¼Œç”¨äºŽæ—¥æœŸå¤„ç†
  }
}
```

## ðŸš€ å®žæ–½æ­¥éª¤

1. âœ… åˆ›å»ºè®¾è®¡æ–‡æ¡£
2. â³ æ•°æ®åº“è¿ç§»ï¼ˆæ·»åŠ  FTS è¡¨å’Œè§¦å‘å™¨ï¼‰
3. â³ åŽç«¯æœç´¢ API å®žçŽ°
4. â³ å‰ç«¯ SearchBar ç»„ä»¶
5. â³ å‰ç«¯ AdvancedFilter ç»„ä»¶
6. â³ é›†æˆåˆ° Sidebar
7. â³ æµ‹è¯•å’Œä¼˜åŒ–
8. â³ æ–‡æ¡£æ›´æ–°

## ðŸ“ åŽç»­ä¼˜åŒ–

- [ ] æœç´¢å»ºè®®ï¼ˆæ ¹æ®åŽ†å²å’Œçƒ­é—¨æœç´¢ï¼‰
- [ ] æœç´¢ç»“æžœç»Ÿè®¡ï¼ˆæ˜¾ç¤ºåŒ¹é…æ•°é‡ï¼‰
- [ ] å¯¼å‡ºæœç´¢ç»“æžœ
- [ ] ä¿å­˜æœç´¢æ¡ä»¶ä¸ºå¿«æ·æ–¹å¼
- [ ] AI è¾…åŠ©æœç´¢ï¼ˆè¯­ä¹‰æœç´¢ï¼‰

---

**è®¾è®¡å®Œæˆæ—¶é—´**: 2025-10-15
**é¢„è®¡å®žæ–½æ—¶é—´**: 1 å¤©
**æŠ€æœ¯éš¾åº¦**: â­â­â­

