# æ–‡ä»¶ç³»ç»Ÿä½¿ç”¨å®¡è®¡æŠ¥å‘Š

> ç”Ÿæˆæ—¶é—´: 2025-10-20
> å®¡è®¡èŒƒå›´: server/routes/* å’Œ server/services/*

## ğŸ“Š æ€»ä½“æ¦‚è§ˆ

### æ•°æ®å­˜å‚¨åˆ†ç±»

| ç±»å‹ | ç”¨é€” | å­˜å‚¨æ–¹å¼ | çŠ¶æ€ |
|------|------|---------|------|
| **ç”¨æˆ·æ•°æ®** | å¯¹è¯ã€ç¬”è®°ã€æ–‡æ¡£ | âœ… æ•°æ®åº“ (app.db) | æ­£ç¡® |
| **é…ç½®æ•°æ®** | APIå¯†é’¥ã€æ¨¡å‹é…ç½® | âœ… æ•°æ®åº“ (user_configs) | æ­£ç¡® |
| **é™æ€èµ„æº** | MCPæ¨¡æ¿ã€å¤´åƒã€çŸ¥è¯†åº“æ–‡ä»¶ | âš ï¸ æ–‡ä»¶ç³»ç»Ÿ | åˆç† |
| **ä¸´æ—¶æ–‡ä»¶** | å¯¼å…¥å¯¼å‡ºã€ä¸Šä¼  | âš ï¸ æ–‡ä»¶ç³»ç»Ÿ | åˆç† |

## âœ… æ­£ç¡®ä½¿ç”¨æ•°æ®åº“çš„è·¯ç”±

### 1. ç”¨æˆ·æ•°æ® (user-data.cjs)
```
âœ… GET/POST /api/user-data/conversations  - æ•°æ®åº“
âœ… GET/POST /api/user-data/config         - æ•°æ®åº“
âœ… POST /api/user-data/search             - æ•°æ®åº“
```

### 2. è®¤è¯ (auth.cjs)
```
âœ… POST /api/auth/register                - æ•°æ®åº“ (users)
âœ… POST /api/auth/login                   - æ•°æ®åº“ (users)
```

### 3. èŠå¤© (chat.cjs) âœ… å·²ä¿®å¤
```
âœ… POST /api/chat                         - æ•°æ®åº“è¯»å–API key
âœ… ä½¿ç”¨ authMiddleware
âœ… ä» user_configs è¯»å– api_keys
```

### 4. ç¬”è®° (notes.cjs)
```
âœ… GET/POST/PUT/DELETE /api/notes         - æ•°æ®åº“
âœ… åˆ†ç±»ã€æ ‡ç­¾ã€æœç´¢éƒ½åœ¨æ•°æ®åº“
```

### 5. æ–‡æ¡£ (documents.cjs)
```
âœ… GET/POST/PUT/DELETE /api/documents     - æ•°æ®åº“
```

### 6. å·¥ä½œæµ (workflows.cjs)
```
âœ… GET/POST/PUT/DELETE /api/workflows     - æ•°æ®åº“
```

### 7. ä»£ç†äºº (agents.cjs)
```
âœ… GET/POST/PUT/DELETE /api/agents        - æ•°æ®åº“
```

### 8. åˆ†æ (analytics.cjs)
```
âœ… GET /api/analytics/*                   - æ•°æ®åº“æŸ¥è¯¢
```

### 9. å¯†ç ä¿é™©åº“ (password-vault.cjs)
```
âœ… GET/POST/PUT/DELETE /api/password-vault - æ•°æ®åº“ + åŠ å¯†
```

## âš ï¸ åˆç†ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿçš„åœºæ™¯

### 1. MCP æ¨¡æ¿ (mcp.cjs)
**æ–‡ä»¶**: `server/data/mcp-templates.json`
**ç”¨é€”**: é™æ€æ¨¡æ¿åº“ï¼Œé¢„å®šä¹‰çš„ MCP æœåŠ¡é…ç½®æ¨¡æ¿
**åŸå› **: 
- åªè¯»æ•°æ®
- ç³»ç»Ÿçº§é…ç½®ï¼Œä¸æ˜¯ç”¨æˆ·æ•°æ®
- ä¾¿äºç‰ˆæœ¬æ§åˆ¶å’Œéƒ¨ç½²
**çŠ¶æ€**: âœ… åˆç†

```javascript
// server/routes/mcp.cjs:293-313
router.get('/templates', (req, res) => {
  const templatesPath = path.join(__dirname, '../data/mcp-templates.json');
  const templates = JSON.parse(fs.readFileSync(templatesPath, 'utf-8'));
  res.json({ templates });
});
```

**ç”¨æˆ·çš„ MCP é…ç½®**: âœ… å­˜å‚¨åœ¨æ•°æ®åº“ `user_mcp_configs` è¡¨

### 2. å¤´åƒä¸Šä¼  (profile.cjs)
**ç›®å½•**: `data/avatars/`
**ç”¨é€”**: å­˜å‚¨ç”¨æˆ·å¤´åƒå›¾ç‰‡
**åŸå› **:
- äºŒè¿›åˆ¶æ–‡ä»¶
- éœ€è¦ç›´æ¥è®¿é—®ï¼ˆé™æ€èµ„æºæœåŠ¡ï¼‰
- æ•°æ®åº“å­˜å‚¨å›¾ç‰‡ä¸åˆé€‚
**çŠ¶æ€**: âœ… åˆç†

```javascript
// server/routes/profile.cjs:11-13
const uploadDir = path.join(__dirname, '../../data/avatars');
if (!fs.existsSync(uploadDir)) {
  fs.mkdirSync(uploadDir, { recursive: true });
}
```

**å¤´åƒè·¯å¾„**: âœ… å­˜å‚¨åœ¨æ•°æ®åº“ `users.avatar` å­—æ®µ

### 3. çŸ¥è¯†åº“æ–‡ä»¶ (knowledge.cjs)
**ç›®å½•**: `data/uploads/knowledge/`
**ç”¨é€”**: å­˜å‚¨ä¸Šä¼ çš„çŸ¥è¯†åº“æ–‡æ¡£ï¼ˆPDFã€Wordç­‰ï¼‰
**åŸå› **:
- å¤§æ–‡ä»¶
- éœ€è¦æ–‡ä»¶è§£æ
- æ•°æ®åº“å­˜å‚¨ä¸åˆé€‚
**çŠ¶æ€**: âœ… åˆç†

```javascript
// server/routes/knowledge.cjs:18-21
destination: (req, file, cb) => {
  const knowledgeDir = path.join(uploadDir, 'knowledge');
  require('fs').mkdirSync(knowledgeDir, { recursive: true });
  cb(null, knowledgeDir);
}
```

**æ–‡ä»¶å…ƒæ•°æ®**: âœ… å­˜å‚¨åœ¨æ•°æ®åº“ `knowledge_bases` å’Œ `knowledge_documents` è¡¨

### 4. å¯¼å…¥å¯¼å‡º (importExport.cjs)
**ç›®å½•**: `uploads/`
**ç”¨é€”**: ä¸´æ—¶å­˜å‚¨ä¸Šä¼ çš„å¯¼å…¥æ–‡ä»¶
**åŸå› **:
- ä¸´æ—¶æ–‡ä»¶
- å¤„ç†åå³åˆ é™¤
- multer éœ€è¦æ–‡ä»¶ç³»ç»Ÿç›®å½•
**çŠ¶æ€**: âœ… åˆç†

```javascript
// server/routes/importExport.cjs:19-34
const upload = multer({
  dest: 'uploads/',  // ä¸´æ—¶ç›®å½•
  limits: { fileSize: 50 * 1024 * 1024 }
});
```

### 5. ä»£ç ç¼–è¾‘å™¨ (code-editor.cjs)
**ç”¨é€”**: Agent è¯»å†™é¡¹ç›®æ–‡ä»¶
**åŸå› **:
- å®é™…çš„ä»£ç æ–‡ä»¶
- é¡¹ç›®æ–‡ä»¶æ“ä½œ
- ä¸æ˜¯æ•°æ®å­˜å‚¨
**çŠ¶æ€**: âœ… åˆç†

```javascript
// server/services/code-editor.cjs
async readFile({ path }) {
  const content = fs.readFileSync(fullPath, 'utf8');
  return { success: true, content };
}

async writeFile({ path, content }) {
  fs.writeFileSync(fullPath, content, 'utf8');
  return { success: true };
}
```

### 6. æ–‡ä»¶è§£æå™¨ (fileParser.cjs)
**ç”¨é€”**: è§£æä¸Šä¼ çš„æ–‡æ¡£å†…å®¹ï¼ˆPDFã€Excelã€Wordç­‰ï¼‰
**åŸå› **:
- å¤„ç†é€»è¾‘éœ€è¦è¯»å–æ–‡ä»¶
- æ–‡ä»¶æ˜¯ä¸´æ—¶çš„
- è§£æåå†…å®¹å­˜å…¥æ•°æ®åº“
**çŠ¶æ€**: âœ… åˆç†

## ğŸ” è¯¦ç»†å®¡è®¡ç»“æœ

### è·¯ç”±å±‚ (server/routes/)

| æ–‡ä»¶ | æ–‡ä»¶ç³»ç»Ÿä½¿ç”¨ | ç”¨é€” | çŠ¶æ€ |
|------|-------------|------|------|
| agents.cjs | âŒ æ—  | æ•°æ®åº“ | âœ… |
| ai-notes.cjs | âŒ æ—  | æ•°æ®åº“ | âœ… |
| analytics.cjs | âŒ æ—  | æ•°æ®åº“ | âœ… |
| auth.cjs | âŒ æ—  | æ•°æ®åº“ | âœ… |
| **chat.cjs** | âŒ æ—  | æ•°æ®åº“ | âœ… å·²ä¿®å¤ |
| documents.cjs | âŒ æ—  | æ•°æ®åº“ | âœ… |
| files.cjs | âš ï¸ æœ‰ | æ–‡ä»¶ä¸Šä¼  | âœ… åˆç† |
| images.cjs | âš ï¸ æœ‰ | å›¾ç‰‡ä¸Šä¼  | âœ… åˆç† |
| **importExport.cjs** | âš ï¸ æœ‰ | ä¸´æ—¶æ–‡ä»¶ | âœ… åˆç† |
| **knowledge.cjs** | âš ï¸ æœ‰ | æ–‡æ¡£å­˜å‚¨ | âœ… åˆç† |
| **mcp.cjs** | âš ï¸ æœ‰ | é™æ€æ¨¡æ¿ | âœ… åˆç† |
| notes.cjs | âŒ æ—  | æ•°æ®åº“ | âœ… |
| password-vault.cjs | âŒ æ—  | æ•°æ®åº“ | âœ… |
| personas.cjs | âŒ æ—  | æ•°æ®åº“ | âœ… |
| **profile.cjs** | âš ï¸ æœ‰ | å¤´åƒå­˜å‚¨ | âœ… åˆç† |
| proxy.cjs | âŒ æ—  | è½¬å‘ | âœ… |
| templateMarketplace.cjs | âŒ æ—  | æ•°æ®åº“ | âœ… |
| test-connection.cjs | âŒ æ—  | APIæµ‹è¯• | âœ… |
| **user-data.cjs** | âŒ æ—  | æ•°æ®åº“ | âœ… æ­£ç¡® |
| workflows.cjs | âŒ æ—  | æ•°æ®åº“ | âœ… |

### æœåŠ¡å±‚ (server/services/)

| æ–‡ä»¶ | æ–‡ä»¶ç³»ç»Ÿä½¿ç”¨ | ç”¨é€” | çŠ¶æ€ |
|------|-------------|------|------|
| **agentEngine.cjs** | âš ï¸ æœ‰ | Agentè¯»å†™æ–‡ä»¶ | âœ… åˆç† |
| **code-editor.cjs** | âš ï¸ æœ‰ | ä»£ç æ–‡ä»¶æ“ä½œ | âœ… åˆç† |
| **exportEngine.cjs** | âš ï¸ æœ‰ | å¯¼å‡ºåŠŸèƒ½ | âœ… åˆç† |
| **fileParser.cjs** | âš ï¸ æœ‰ | æ–‡ä»¶è§£æ | âœ… åˆç† |
| **fileUpload.cjs** | âš ï¸ æœ‰ | æ–‡ä»¶ä¸Šä¼  | âœ… åˆç† |
| **imageUpload.cjs** | âš ï¸ æœ‰ | å›¾ç‰‡ä¸Šä¼  | âœ… åˆç† |
| **importEngine.cjs** | âš ï¸ æœ‰ | å¯¼å…¥åŠŸèƒ½ | âœ… åˆç† |
| **visionClient.cjs** | âš ï¸ æœ‰ | å›¾ç‰‡è¯†åˆ« | âœ… åˆç† |
| å…¶ä»–æœåŠ¡ | âŒ æ—  | çº¯é€»è¾‘ | âœ… |

## ğŸ—„ï¸ æ–‡ä»¶ç³»ç»Ÿç›®å½•ç»“æ„

```
data/
â”œâ”€â”€ app.db                    # âœ… ä¸»æ•°æ®åº“ (SQLite)
â”œâ”€â”€ database.json             # âŒ æ—§æ•°æ®ï¼ˆå·²åºŸå¼ƒï¼‰
â”œâ”€â”€ user-config.json          # âŒ æ—§é…ç½®ï¼ˆå·²åºŸå¼ƒï¼‰
â”œâ”€â”€ config.json               # âš ï¸ ç³»ç»Ÿé…ç½®ï¼ˆåˆç†ï¼‰
â”œâ”€â”€ mcp-templates.json        # âœ… é™æ€æ¨¡æ¿ï¼ˆåˆç†ï¼‰
â”œâ”€â”€ avatars/                  # âœ… ç”¨æˆ·å¤´åƒï¼ˆåˆç†ï¼‰
â”‚   â””â”€â”€ avatar-{userId}-{timestamp}.jpg
â”œâ”€â”€ uploads/                  # âœ… ä¸´æ—¶ä¸Šä¼ ï¼ˆåˆç†ï¼‰
â”‚   â””â”€â”€ knowledge/            # çŸ¥è¯†åº“æ–‡æ¡£
â””â”€â”€ backups/                  # âœ… å¤‡ä»½æ–‡ä»¶ï¼ˆåˆç†ï¼‰
```

## âŒ å·²åˆ é™¤çš„æ–‡ä»¶ç³»ç»Ÿé…ç½®

### åˆ é™¤çš„æ–‡ä»¶
```
server/routes/config.cjs              â†’ server/_deprecated/
server/services/configManager.cjs     â†’ server/_deprecated/
server/services/config-storage.cjs    â†’ server/_deprecated/
```

### åˆ é™¤çš„è·¯ç”±
```
âŒ GET/POST /api/config/*
âœ… æ”¹ç”¨ /api/user-data/config (æ•°æ®åº“)
```

## ğŸ“‹ æ•°æ®åº“è¡¨æ¦‚è§ˆ

```sql
-- ç”¨æˆ·ç›¸å…³
users                    -- ç”¨æˆ·è´¦å·
user_configs             -- ç”¨æˆ·é…ç½®ï¼ˆAPI keysã€æ¨¡å‹é…ç½®ç­‰ï¼‰
user_mcp_configs         -- ç”¨æˆ·MCPæœåŠ¡é…ç½®

-- å¯¹è¯ç›¸å…³
conversations            -- å¯¹è¯åˆ—è¡¨
messages                 -- æ¶ˆæ¯å†…å®¹

-- åŠŸèƒ½ç›¸å…³
notes                    -- ç¬”è®°
documents                -- æ–‡æ¡£
workflows                -- å·¥ä½œæµ
agents                   -- ä»£ç†äºº
knowledge_bases          -- çŸ¥è¯†åº“
knowledge_documents      -- çŸ¥è¯†åº“æ–‡æ¡£å…ƒæ•°æ®
password_vault           -- å¯†ç ä¿é™©åº“

-- ç³»ç»Ÿç›¸å…³
templates                -- æ¨¡æ¿
personas                 -- è§’è‰²
```

## âœ… ç»“è®º

### å½“å‰çŠ¶æ€: ä¼˜ç§€ ğŸ‰

1. **æ ¸å¿ƒæ•°æ®**: âœ… å…¨éƒ¨ä½¿ç”¨æ•°æ®åº“
   - ç”¨æˆ·æ•°æ®ã€å¯¹è¯ã€ç¬”è®°ã€æ–‡æ¡£ç­‰éƒ½åœ¨æ•°æ®åº“
   - APIå¯†é’¥ç­‰æ•æ„Ÿé…ç½®å­˜å‚¨åœ¨æ•°æ®åº“

2. **æ–‡ä»¶ç³»ç»Ÿä½¿ç”¨**: âœ… åˆç†ä¸”å¿…è¦
   - ä»…ç”¨äºé™æ€èµ„æºï¼ˆå¤´åƒã€æ–‡æ¡£æ–‡ä»¶ï¼‰
   - ä¸´æ—¶æ–‡ä»¶ï¼ˆå¯¼å…¥å¯¼å‡ºã€ä¸Šä¼ ï¼‰
   - ç³»ç»Ÿé…ç½®æ–‡ä»¶ï¼ˆMCPæ¨¡æ¿ï¼‰

3. **å·²ä¿®å¤é—®é¢˜**: âœ…
   - âœ… åˆ é™¤äº†æ–‡ä»¶é…ç½®ç³»ç»Ÿ
   - âœ… chat.cjs æ”¹ç”¨æ•°æ®åº“
   - âœ… ç»Ÿä¸€ä½¿ç”¨ user_configs è¡¨

### æ¨èæ¶æ„

```
æ•°æ®åº“ (app.db)
  â”œâ”€â”€ ç”¨æˆ·æ•°æ® (å¯¹è¯ã€ç¬”è®°ã€æ–‡æ¡£)
  â”œâ”€â”€ é…ç½®æ•°æ® (API keysã€è®¾ç½®)
  â””â”€â”€ ç³»ç»Ÿæ•°æ® (å·¥ä½œæµã€ä»£ç†äºº)

æ–‡ä»¶ç³»ç»Ÿ
  â”œâ”€â”€ é™æ€èµ„æº (å¤´åƒã€æ–‡æ¡£æ–‡ä»¶)
  â”œâ”€â”€ ä¸´æ—¶æ–‡ä»¶ (ä¸Šä¼ ã€å¯¼å…¥å¯¼å‡º)
  â””â”€â”€ ç³»ç»Ÿé…ç½® (MCPæ¨¡æ¿ã€åªè¯»)
```

### æ— éœ€è¿›ä¸€æ­¥ä¿®æ”¹

æ‰€æœ‰ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿçš„åœ°æ–¹éƒ½æ˜¯**åˆç†ä¸”å¿…è¦**çš„ï¼š

1. **é™æ€èµ„æº** - å›¾ç‰‡ã€æ–‡æ¡£æ–‡ä»¶ä¸é€‚åˆæ”¾æ•°æ®åº“
2. **ä¸´æ—¶æ–‡ä»¶** - å¤„ç†åå³åˆ é™¤
3. **ä»£ç æ–‡ä»¶** - Agentéœ€è¦æ“ä½œå®é™…æ–‡ä»¶
4. **ç³»ç»Ÿæ¨¡æ¿** - åªè¯»é…ç½®ï¼Œä¾¿äºç‰ˆæœ¬æ§åˆ¶

## ğŸ¯ æœ€ä½³å®è·µéªŒè¯

âœ… ç”¨æˆ·æ•°æ® â†’ æ•°æ®åº“  
âœ… é…ç½®æ•°æ® â†’ æ•°æ®åº“  
âœ… å¤§æ–‡ä»¶ â†’ æ–‡ä»¶ç³»ç»Ÿ (è·¯å¾„å­˜æ•°æ®åº“)  
âœ… ä¸´æ—¶æ–‡ä»¶ â†’ æ–‡ä»¶ç³»ç»Ÿ (å¤„ç†ååˆ é™¤)  
âœ… é™æ€èµ„æº â†’ æ–‡ä»¶ç³»ç»Ÿ  
âœ… æ•æ„Ÿæ•°æ® â†’ æ•°æ®åº“ (åŠ å¯†)  

## ğŸ“Š ç»Ÿè®¡æ•°æ®

- **æ€»è·¯ç”±**: 20 ä¸ª
- **ä½¿ç”¨æ•°æ®åº“**: 14 ä¸ª (70%)
- **ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿ**: 6 ä¸ª (30%) - å…¨éƒ¨åˆç†
- **å·²ä¿®å¤**: chat.cjs ä»æ–‡ä»¶æ”¹ä¸ºæ•°æ®åº“
- **å·²åˆ é™¤**: config.cjs ç­‰é…ç½®æ–‡ä»¶

**å®¡è®¡ç»“è®º**: âœ… é€šè¿‡ - æ¶æ„è®¾è®¡åˆç†ï¼Œæ•°æ®å­˜å‚¨æ­£ç¡®
